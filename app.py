from dotenv import load_dotenv
load_dotenv()

import sqlite3
import pandas as pd
import os
import threading
import http.server
import socketserver
import functools
import time
from pathlib import Path
from src import db as _db
from modules.marketplace.utils import init_db

# Inicializar base de datos
init_db()

# Configurar p√°gina con layout amplio
import streamlit as st
st.set_page_config(layout='wide')

# L√ìGICA DE NAVEGACI√ìN MAESTRA
if 'selected_page' not in st.session_state or st.session_state['selected_page'] == "":
    st.session_state['selected_page'] = "üè† Inicio / Marketplace"

# Detectar si hay una finca seleccionada en los par√°metros de consulta
params = st.query_params

# Detectar navegaci√≥n al panel de cliente desde project_detail
if st.session_state.get("navigate_to_client_panel"):
    # Limpiar el flag de navegaci√≥n
    del st.session_state["navigate_to_client_panel"]
    # Usar el mismo mecanismo que el bot√≥n "Acceso Clientes" en HOME
    st.query_params["page"] = "üë§ Panel de Cliente"
    # Si hay proyecto seleccionado, mantenerlo en query_params
    if "selected_project_for_panel" in st.session_state:
        if "selected_project" in st.query_params:
            del st.query_params["selected_project"]
        del st.session_state["selected_project_for_panel"]
    st.rerun()

# Detectar p√°gina seleccionada por query param
page_from_query = params.get("page")

# # Interceptar p√°ginas especiales por query param (VIEJAS)
# if page_from_query == "üõí Comprar Proyecto":
#     try:
#         import modules.marketplace.project_purchase_panel as project_purchase_panel
#         project_purchase_panel.main()
#         st.stop()
#     except Exception as e:
#         st.error(f"Error mostrando panel de compra: {e}")

# if page_from_query == "üë§ Panel de Cliente":
#     try:
#         from modules.marketplace import client_panel_fixed as client_panel
#         client_panel.main()
#         st.stop()
#     except Exception as e:
#         st.error(f"Error mostrando panel de cliente: {e}")

# === RUTAS VIEJAS COMENTADAS (NO USAR - VERSIONES ANTIGUAS) ===
# if "selected_plot" in params:
#     try:
#         plot_id = params["selected_plot"]
#         from modules.marketplace.plot_detail import show_plot_detail_page
#         show_plot_detail_page(plot_id)
#         st.stop()  # Detener la ejecuci√≥n para no mostrar el resto de la app
#     except Exception as e:
#         st.error(f"Error mostrando detalles de la finca: {e}")

# if "selected_project" in params and not page_from_query: 
#     try:
#         project_id = params["selected_project"]
#         from modules.marketplace.project_detail import show_project_detail_page
#         show_project_detail_page(project_id)
#         st.stop()  # Detener la ejecuci√≥n para no mostrar el resto de la app
#     except Exception as e:
#         st.error(f"Error mostrando detalles del proyecto: {e}")

# # Interceptar p√°ginas especiales por query param (VIEJAS)
# if page_from_query == "üõí Comprar Proyecto":
#     try:
#         import modules.marketplace.project_purchase_panel as project_purchase_panel
#         project_purchase_panel.main()
#         st.stop()
#     except Exception as e:
#         st.error(f"Error mostrando panel de compra: {e}")

# if page_from_query == "üë§ Panel de Cliente":
#     try:
#         from modules.marketplace import client_panel_fixed as client_panel
#         client_panel.main()
#         st.stop()
#     except Exception as e:
#         st.error(f"Error mostrando panel de cliente: {e}")

# if "selected_plot" in params:
#     try:
#         plot_id = params["selected_plot"]
#         from modules.marketplace.plot_detail import show_plot_detail_page
#         show_plot_detail_page(plot_id)
#         st.stop()  # Detener la ejecuci√≥n para no mostrar el resto de la app
#     except Exception as e:
#         st.error(f"Error mostrando detalles de la finca: {e}")

# if "selected_project" in params and not page_from_query: 
#     try:
#         project_id = params["selected_project"]
#         from modules.marketplace.project_detail import show_project_detail_page
#         show_project_detail_page(project_id)
#         st.stop()  # Detener la ejecuci√≥n para no mostrar el resto de la app
#     except Exception as e:
#         st.error(f"Error mostrando detalles del proyecto: {e}")

# === FUNCIONES V2 (COPIA EXACTA DEL CONTENIDO ORIGINAL) ===

def detalles_proyecto_v2(project_id: str):
    """Muestra la p√°gina de vista previa de un proyecto arquitect√≥nico - VERSI√ìN V2"""
    # modules/marketplace/project_detail.py

    import json
    from modules.marketplace.plot_detail import get_project_images
    from src import db

    def normalize_gallery(galeria_fotos):
        import json
        if not galeria_fotos:
            return []
        if isinstance(galeria_fotos, list):
            return [f for f in galeria_fotos if f]
        if isinstance(galeria_fotos, str):
            try:
                data = json.loads(galeria_fotos)
                if isinstance(data, list):
                    return [f for f in data if f]
            except:
                return []
        return []

    # Limpiar sidebar para vista dedicada
    st.sidebar.empty()

    # Obtener datos del proyecto
    conn = db.get_conn()
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, title, description, m2_construidos, area_m2, price, estimated_cost,
               price_memoria, price_cad, property_type, foto_principal, galeria_fotos,
               memoria_pdf, planos_pdf, planos_dwg, modelo_3d_glb, vr_tour, energy_rating,
               architect_name, characteristics_json, habitaciones, banos, garaje, plantas,
               m2_parcela_minima, m2_parcela_maxima, certificacion_energetica, tipo_proyecto
        FROM projects
        WHERE id = ?
    """, (project_id,))
    row = cursor.fetchone()
    conn.close()

    if not row:
        st.error("‚ùå Proyecto no encontrado")
        return

    # Extraer datos del proyecto
    project_data = {
        'id': row[0],
        'title': row[1],
        'description': row[2],
        'm2_construidos': row[3],
        'area_m2': row[4],
        'price': row[5],
        'estimated_cost': row[6],
        'price_memoria': row[7] or 1800,
        'price_cad': row[8] or 2500,
        'property_type': row[9],
        'foto_principal': row[10],
        'galeria_fotos': row[11],
        'memoria_pdf': row[12],
        'planos_pdf': row[13],
        'planos_dwg': row[14],
        'modelo_3d_glb': row[15],
        'vr_tour': row[16],
        'energy_rating': row[17],
        'architect_name': row[18],
        'characteristics': json.loads(row[19]) if row[19] else {},
        'habitaciones': row[20],
        'banos': row[21],
        'garaje': row[22],
        'plantas': row[23],
        'm2_parcela_minima': row[24],
        'm2_parcela_maxima': row[25],
        'certificacion_energetica': row[26],
        'tipo_proyecto': row[27]
    }

    gallery = normalize_gallery(project_data["galeria_fotos"])

    # Definir variables de login temprano para evitar errores
    client_logged_in = st.session_state.get("client_logged_in", False)
    client_email = st.session_state.get("client_email", "")

    # Calcular superficie m√≠nima requerida
    m2_proyecto = project_data['m2_construidos'] or project_data['area_m2'] or 0
    if project_data['m2_parcela_minima']:
        superficie_minima = project_data['m2_parcela_minima']
    else:
        superficie_minima = m2_proyecto / 0.33 if m2_proyecto > 0 else 0

    # T√≠tulo
    st.title(f"üèóÔ∏è {project_data['title']}")

    # Galer√≠a de fotos
    st.header("üì∏ Galer√≠a del Proyecto")

    # Obtener im√°genes v√°lidas
    project_images = get_project_images({
        'foto_principal': project_data['foto_principal'],
        'galeria_fotos': gallery
    })

    if project_images:
        # Mostrar im√°genes en grid
        cols = st.columns(min(len(project_images), 3))
        for idx, img_path in enumerate(project_images):
            with cols[idx % 3]:
                try:
                    st.image(img_path, width='stretch', caption=f"Imagen {idx + 1}")
                except Exception as e:
                    st.warning(f"No se pudo cargar la imagen {idx + 1}")
    else:
        st.info("No hay im√°genes disponibles para este proyecto")

    # Informaci√≥n b√°sica del proyecto
    st.header("üìã Informaci√≥n del Proyecto")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üè† Caracter√≠sticas T√©cnicas")
        st.write(f"**Superficie construida:** {m2_proyecto:.0f} m¬≤")
        st.write(f"**Superficie m√≠nima de terreno:** {superficie_minima:.0f} m¬≤")
        if project_data['m2_parcela_maxima']:
            st.write(f"**Superficie m√°xima de terreno:** {project_data['m2_parcela_maxima']:.0f} m¬≤")
        st.write(f"**Tipo:** {project_data['property_type'] or project_data['tipo_proyecto'] or 'Residencial'}")

        # Caracter√≠sticas espec√≠ficas
        if project_data['habitaciones']:
            st.write(f"**Habitaciones:** {project_data['habitaciones']}")
        if project_data['banos']:
            st.write(f"**Ba√±os:** {project_data['banos']}")
        if project_data['plantas']:
            st.write(f"**Plantas:** {project_data['plantas']}")
        if project_data['garaje']:
            st.write(f"**Garaje:** {'S√≠' if project_data['garaje'] else 'No'}")

        # Certificaci√≥n energ√©tica
        if project_data['certificacion_energetica'] or project_data['energy_rating']:
            rating = project_data['certificacion_energetica'] or project_data['energy_rating']
            st.write(f"**Certificaci√≥n energ√©tica:** {rating}")

    with col2:
        st.subheader("üí∞ Informaci√≥n Econ√≥mica")
        if project_data['estimated_cost']:
            st.write(f"**Coste de ejecuci√≥n aproximado:** ‚Ç¨{project_data['estimated_cost']:,.0f}")
        st.write("**Precio descarga proyecto completo:**")
        st.write(f"‚Ä¢ PDF (Memoria completa): ‚Ç¨{project_data['price_memoria']}")
        st.write(f"‚Ä¢ CAD (Planos editables): ‚Ç¨{project_data['price_cad']}")

        # Los botones de compra se muestran al final del flujo

    # Descripci√≥n
    if project_data['description']:
        st.header("üìù Descripci√≥n")
        st.write(project_data['description'])

    # Arquitecto
    if project_data['architect_name']:
        st.write(f"**Arquitecto:** {project_data['architect_name']}")

    # RESUMEN INTELIGENTE CON IA
    st.header("ü§ñ An√°lisis Inteligente con IA")

    # --- DEPURACI√ìN T√âCNICA ---
    from modules.marketplace.project_detail import get_project_by_id
    from modules.marketplace import ai_engine_groq as ai

    # Obtener proyecto con OCR data
    project_full = get_project_by_id(project_id)

    # 1. BOT√ìN DE DOSSIER (Texto corto para evitar cortes)
    if st.button("üìã GENERAR DOSSIER PREVENTA"):
        texto = project_full.get('ocr_text', "No hay datos en la DB")
        with st.spinner("Analizando..."):
            resumen = ai.generate_text(f"Resume en 150 palabras materiales y estilo de: {texto[:2000]}")
            st.info(resumen)

    # 2. BOT√ìN DE PLANO (La clave de lo que buscas)
    if st.button("üìê GENERAR PLANO T√âCNICO"):
        texto = project_full.get('ocr_text', "")
        if not texto:
            st.error("Error: No hay memoria t√©cnica guardada en la base de datos para este proyecto.")
        else:
            with st.spinner("Dibujando plano..."):
                plano = ai.generate_ascii_plan_only(texto)
                st.code(plano, language="text")

    # VISUALIZACIONES DEL PROYECTO
    st.header("üèóÔ∏è Visualizaciones del Proyecto")

    tab_3d, tab_vr, tab_fotos = st.tabs(["üé• 3D", "ü•Ω VR", "üñºÔ∏è Fotos / Planos"])

    with tab_3d:
        # Sistema de roles tipo Airbnb - diferenciaci√≥n de acceso al visor 3D
        user_role = None
        has_project_access = False

        if client_logged_in and client_email:
            # Obtener rol del usuario desde la base de datos
            try:
                from modules.marketplace.utils import get_user_by_email
                user_data = get_user_by_email(client_email)
                if user_data:
                    user_role = user_data.get('role')
            except:
                user_role = None

            # Verificar acceso seg√∫n rol
            if user_role == 'client':
                # Cliente siempre puede ver el 3D de proyectos que est√° viendo
                has_project_access = True
            elif user_role == 'architect':
                # Arquitecto puede ver el 3D de sus propios proyectos
                conn_check = db.get_conn()
                cursor_check = conn_check.cursor()
                cursor_check.execute("SELECT architect_id FROM projects WHERE id = ?", (project_id,))
                project_architect = cursor_check.fetchone()
                conn_check.close()
                if project_architect and project_architect[0] == user_data.get('id'):
                    has_project_access = True
            elif user_role == 'services':
                # Proveedor de servicios solo ve 3D si tiene el proyecto asignado
                conn_check = db.get_conn()
                cursor_check = conn_check.cursor()
                cursor_check.execute("""
                    SELECT sa.id FROM service_assignments sa
                    JOIN service_providers sp ON sa.proveedor_id = sp.id
                    WHERE sp.email = ? AND sa.proyecto_id = ?
                """, (client_email, project_id))
                assignment = cursor_check.fetchone()
                conn_check.close()
                if assignment:
                    has_project_access = True

        if has_project_access:
            st.markdown("#### üé• Visor 3D del Proyecto")
            if project_data.get("modelo_3d_glb"):
                # Mostrar visor 3D completo
                rel_path = str(project_data["modelo_3d_glb"]).replace("\\", "/").lstrip("/")
                model_url = f"http://localhost:8765/{rel_path}".replace(" ", "%20")

                # HTML con Three.js para visor 3D
                three_html = f"""
                <div id="container3d" style="width: 100%; height: 700px; border: 1px solid #ccc;"></div>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
                <script>
                    // Inicializar escena, c√°mara y renderer
                    const scene = new THREE.Scene();
                    scene.background = new THREE.Color(0xf0f0f0);

                    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    camera.position.set(5, 5, 5);

                    const renderer = new THREE.WebGLRenderer({{ antialias: true }});
                    renderer.setSize(document.getElementById('container3d').clientWidth, 700);
                    renderer.shadowMap.enabled = true;
                    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    document.getElementById('container3d').appendChild(renderer.domElement);

                    // Controles de √≥rbita
                    const controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;

                    // Luces
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                    scene.add(ambientLight);

                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(10, 10, 5);
                    directionalLight.castShadow = true;
                    scene.add(directionalLight);

                    // Cargar modelo GLTF
                    const loader = new THREE.GLTFLoader();
                    console.log('Loading model from:', '{model_url}');
                    loader.load(
                        '{model_url}',
                        function (gltf) {{
                            console.log('Modelo cargado exitosamente:', gltf);
                            const model = gltf.scene;
                            scene.add(model);

                            // Calcular bounding box para centrar la c√°mara
                            const box = new THREE.Box3().setFromObject(model);
                            const center = box.getCenter(new THREE.Vector3());
                            const size = box.getSize(new THREE.Vector3());

                            // Centrar modelo en origen
                            model.position.sub(center);

                            // Ajustar c√°mara para ver todo el modelo
                            const maxDim = Math.max(size.x, size.y, size.z);
                            const fov = camera.fov * (Math.PI / 180);
                            let cameraZ = Math.abs(maxDim / Math.sin(fov / 2));

                            camera.position.set(center.x, center.y, center.z + cameraZ * 1.5);
                            camera.lookAt(center);

                            controls.target.copy(center);
                            controls.update();

                            // Habilitar sombras si el modelo las soporta
                            model.traverse(function (child) {{
                                if (child.isMesh) {{
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                }}
                            }});
                        }},
                        function (xhr) {{
                            console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                        }},
                        function (error) {{
                            console.error('Error loading GLTF:', error);
                            alert('Error cargando el modelo 3D. Verifica que el archivo exista.');
                        }}
                    );

                    // Funci√≥n de animaci√≥n
                    function animate() {{
                        requestAnimationFrame(animate);
                        controls.update();
                        renderer.render(scene, camera);
                    }}
                    animate();

                    // Ajustar tama√±o al cambiar ventana
                    window.addEventListener('resize', function() {{
                        camera.aspect = document.getElementById('container3d').clientWidth / 700;
                        camera.updateProjectionMatrix();
                        renderer.setSize(document.getElementById('container3d').clientWidth, 700);
                    }});
                </script>
                """

                st.components.v1.html(three_html, height=700, scrolling=False)
            else:
                st.info("Este proyecto no tiene modelo 3D disponible.")
        else:
            # Mensaje espec√≠fico seg√∫n el rol del usuario
            if user_role == 'services':
                st.warning("üîí Como proveedor de servicios, solo puedes ver el modelo 3D de proyectos que tienes asignados.")
                st.info("Contacta al cliente para que te asigne este proyecto si necesitas acceso al modelo 3D.")
            elif user_role == 'architect':
                st.warning("üîí Solo puedes ver el modelo 3D de tus propios proyectos.")
            else:
                st.info("üîí Para ver el modelo 3D interactivo completo, reg√≠strate como cliente.")
                st.markdown("**Vista previa limitada:** Los modelos 3D se desbloquean tras registro.")

    with tab_vr:
        if client_logged_in:
            st.markdown("**EST√ÅS EN LA VERSI√ìN V2**")
            st.markdown("#### ü•Ω Visor de Realidad Virtual")
            if project_data.get("modelo_3d_glb"):
                rel = str(project_data["modelo_3d_glb"]).replace("\\", "/").lstrip("/")
                glb_url = f"http://localhost:8765/{rel}".replace(" ", "%20") + "?v=123"
                viewer_url = f"http://localhost:8765/static/vr_viewer.html?model={glb_url}"
                st.markdown(
                    f'<iframe src="{viewer_url}" width="100%" height="600" allow="accelerometer; gyroscope; xr-spatial-tracking; vr" frameborder="0"></iframe>',
                    unsafe_allow_html=True,
                )
                st.caption("Visor VR integrado. Si no funciona, verifica permisos del navegador.")
            else:
                st.info("Este proyecto no tiene modelo VR disponible.")
        else:
            st.info("üîí Para acceder a la experiencia VR completa, reg√≠strate como cliente.")
            st.markdown("**Vista previa:** VR disponible tras registro.")

    with tab_fotos:
        if client_logged_in:
            st.markdown("#### üñºÔ∏è Galer√≠a Completa de Fotos y Planos")
            # Foto principal
            if project_data.get("foto_principal"):
                rel = project_data["foto_principal"].replace("\\", "/").lstrip("/")
                url = f"http://localhost:8765/{rel}"
                st.image(url, width=400, caption="Foto Principal")
            # Galer√≠a adicional
            if gallery:
                st.subheader("Galer√≠a Adicional")
                for idx, foto in enumerate(gallery):
                    if foto:
                        rel = foto.replace("\\", "/").lstrip("/")
                        url = f"http://localhost:8765/{rel}"
                        st.image(url, width=300, caption=f"Imagen {idx + 1}")
            # Planos
            if project_data.get("planos_pdf") or project_data.get("planos_dwg"):
                st.subheader("Planos T√©cnicos")
                if project_data.get("planos_pdf"):
                    st.download_button("üìÑ Descargar Planos PDF", data=open(project_data["planos_pdf"], "rb"), file_name="planos.pdf")
                if project_data.get("planos_dwg"):
                    st.download_button("üìê Descargar Planos DWG", data=open(project_data["planos_dwg"], "rb"), file_name="planos.dwg")
        else:
            st.info("üîí Para ver la galer√≠a completa de fotos y planos, reg√≠strate como cliente.")

    # üîç BUSCAR PROYECTOS SIMILARES (solo para usuarios logueados)
    if client_logged_in:
        st.header("üîç Buscar Proyectos Similares")
        st.write("Encuentra otros proyectos que se ajusten a tus necesidades espec√≠ficas")

        # Formulario de b√∫squeda
        with st.form("similar_projects_form_v2"):
            st.markdown("### üéØ Especifica tus criterios")

            col1, col2 = st.columns(2)

            with col1:
                presupuesto_max = st.number_input(
                    "üí∞ Presupuesto m√°ximo (‚Ç¨)",
                    min_value=0,
                    value=int(project_data.get('price') or 0),
                    step=10000,
                    help="Precio m√°ximo que est√°s dispuesto a pagar"
                )

                area_deseada = st.number_input(
                    "üìê √Årea de construcci√≥n deseada (m¬≤)",
                    min_value=0,
                    value=int(project_data.get('m2_construidos') or 0),
                    step=10,
                    help="Superficie aproximada que quieres construir"
                )

            with col2:
                parcela_disponible = st.number_input(
                    "üèûÔ∏è Parcela disponible (m¬≤)",
                    min_value=0,
                    value=int(project_data.get('m2_parcela_minima') or 0),
                    step=50,
                    help="Tama√±o de terreno que tienes disponible"
                )

                # Checkbox para buscar solo proyectos que quepan
                solo_compatibles = st.checkbox(
                    "Solo proyectos compatibles con mi parcela",
                    value=True,
                    help="Filtrar proyectos cuya parcela m√≠nima sea ‚â§ a tu terreno disponible"
                )

            # Bot√≥n de b√∫squeda
            submitted = st.form_submit_button("üîç Buscar Proyectos Similares", type="primary", width='stretch')

        # Procesar b√∫squeda
        if submitted:
            # Preparar par√°metros
            search_params = {
                'client_budget': presupuesto_max if presupuesto_max > 0 else None,
                'client_desired_area': area_deseada if area_deseada > 0 else None,
                'client_parcel_size': parcela_disponible if parcela_disponible > 0 and solo_compatibles else None,
                'client_email': client_email
            }

            # Mostrar criterios de b√∫squeda
            st.markdown("### üìã Criterios de b√∫squeda aplicados:")
            criterios = []
            if search_params['client_budget']:
                criterios.append(f"üí∞ Presupuesto ‚â§ ‚Ç¨{search_params['client_budget']:,}")
            if search_params['client_desired_area']:
                criterios.append(f"üìê √Årea ‚âà {search_params['client_desired_area']} m¬≤ (¬±20%)")
            if search_params['client_parcel_size']:
                criterios.append(f"üèûÔ∏è Parcela ‚â• {search_params['client_parcel_size']} m¬≤")

            if criterios:
                for criterio in criterios:
                    st.write(f"‚Ä¢ {criterio}")
            else:
                st.info("No se aplicaron filtros espec√≠ficos - mostrando todos los proyectos disponibles")

            # Buscar proyectos
            with st.spinner("Buscando proyectos similares..."):
                from modules.marketplace.compatibilidad import get_proyectos_compatibles
                proyectos = get_proyectos_compatibles(**search_params)

            # Filtrar para excluir el proyecto actual
            proyectos = [p for p in proyectos if str(p['id']) != str(project_id)]

            # Mostrar resultados
            st.markdown(f"### üèóÔ∏è Proyectos similares encontrados: {len(proyectos)}")

            if not proyectos:
                st.warning("No se encontraron proyectos que cumplan con tus criterios. Prueba ampliando los l√≠mites.")
            else:
                # Mostrar proyectos en grid
                cols = st.columns(2)
                for idx, proyecto in enumerate(proyectos):
                    with cols[idx % 2]:
                        # Tarjeta de proyecto
                        with st.container():
                            # Imagen
                            foto = proyecto.get('foto_principal')
                            if foto:
                                try:
                                    st.image(foto, width=250, caption=proyecto['title'])
                                except:
                                    st.image("assets/fincas/image1.jpg", width=250, caption=proyecto['title'])
                            else:
                                st.image("assets/fincas/image1.jpg", width=250, caption=proyecto['title'])

                            # Informaci√≥n b√°sica
                            st.markdown(f"**üèóÔ∏è {proyecto['title']}**")
                            st.write(f"üìê **√Årea:** {proyecto.get('m2_construidos', proyecto.get('area_m2', 'N/D'))} m¬≤")
                            st.write(f"üí∞ **Precio:** ‚Ç¨{proyecto.get('price', 0):,.0f}" if proyecto.get('price') else "üí∞ **Precio:** Consultar")

                            # Arquitecto
                            if proyecto.get('architect_name'):
                                st.write(f"üë®‚Äçüíº **Arquitecto:** {proyecto['architect_name']}")

                            # Compatibilidad
                            if search_params['client_parcel_size'] and proyecto.get('m2_parcela_minima'):
                                if proyecto['m2_parcela_minima'] <= search_params['client_parcel_size']:
                                    st.success("‚úÖ Compatible con tu parcela")
                                else:
                                    st.warning(f"‚ö†Ô∏è Necesita parcela ‚â• {proyecto['m2_parcela_minima']} m¬≤")

                            # Bot√≥n de detalles
                            if st.button("Ver Detalles", key=f"similar_detail_v2_{proyecto['id']}", width='stretch'):
                                st.query_params["selected_project_v2"] = proyecto['id']
                                st.rerun()

                            # Botones de compra directa
                            # Verificar si ya compr√≥ este proyecto
                            conn_check = db_conn()
                            cursor_check = conn_check.cursor()
                            cursor_check.execute("SELECT id FROM ventas_proyectos WHERE proyecto_id = ? AND cliente_email = ?", (proyecto['id'], client_email))
                            ya_compro = cursor_check.fetchone()
                            conn_check.close()

                            if ya_compro:
                                st.success("‚úÖ Ya adquirido")
                            else:
                                # Botones de compra
                                col_buy_pdf, col_buy_cad = st.columns(2)
                                with col_buy_pdf:
                                    if st.button(f"üìÑ PDF ‚Ç¨{proyecto.get('price_memoria', 1800)}", key=f"buy_similar_pdf_{proyecto['id']}", use_container_width=True):
                                        # Simular compra de PDF
                                        with st.spinner("Procesando compra..."):
                                            import time
                                            time.sleep(1)
                                        # Registrar compra
                                        conn_buy = db_conn()
                                        cursor_buy = conn_buy.cursor()
                                        cursor_buy.execute("""
                                            INSERT INTO ventas_proyectos
                                            (proyecto_id, cliente_email, nombre_cliente, productos_comprados, total_pagado, metodo_pago, fecha_compra)
                                            VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                                        """, (proyecto['id'], client_email, "Compra desde similares", "PDF", proyecto.get('price_memoria', 1800), "Simulado"))
                                        conn_buy.commit()
                                        conn_buy.close()
                                        st.success("üéâ PDF comprado!")
                                        st.rerun()

                                with col_buy_cad:
                                    if st.button(f"üñ•Ô∏è CAD ‚Ç¨{proyecto.get('price_cad', 2500)}", key=f"buy_similar_cad_{proyecto['id']}", use_container_width=True):
                                        # Simular compra de CAD
                                        with st.spinner("Procesando compra..."):
                                            import time
                                            time.sleep(1)
                                        # Registrar compra
                                        conn_buy = db_conn()
                                        cursor_buy = conn_buy.cursor()
                                        cursor_buy.execute("""
                                            INSERT INTO ventas_proyectos
                                            (proyecto_id, cliente_email, nombre_cliente, productos_comprados, total_pagado, metodo_pago, fecha_compra)
                                            VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                                        """, (proyecto['id'], client_email, "Compra desde similares", "CAD", proyecto.get('price_cad', 2500), "Simulado"))
                                        conn_buy.commit()
                                        conn_buy.close()
                                        st.success("üéâ CAD comprado!")
                                        st.rerun()

                            st.markdown("---")

    else:
        st.header("üîç ¬øInteresado en este proyecto?")
        st.info("Para ver planos detallados, ficha t√©cnica completa, archivos 3D y realidad virtual, reg√≠strate como cliente.")

        # üîç BUSCAR PROYECTOS COMPATIBLES (antes del registro)
        # Aqu√≠ ir√≠a show_advanced_project_search(client_email=None) pero lo omitimos por simplicidad en v2

        # Usuario no logueado - mostrar formulario de registro r√°pido
        st.subheader("üìù Reg√≠strate para acceder")

        with st.form("registro_rapido_v2"):
            col1, col2 = st.columns(2)

            with col1:
                nombre = st.text_input("Nombre", placeholder="Tu nombre")
                apellidos = st.text_input("Apellidos", placeholder="Tus apellidos")
                telefono = st.text_input("Tel√©fono", placeholder="+34 600 000 000")

            with col2:
                email = st.text_input("Email", placeholder="tu@email.com")
                confirmar_email = st.text_input("Confirmar Email", placeholder="tu@email.com")
                direccion = st.text_input("Direcci√≥n", placeholder="Calle, Ciudad, Provincia")

            submitted = st.form_submit_button("üöÄ Registrarme y Acceder", type="primary", width='stretch')

            if submitted:
                # Validaciones b√°sicas
                if not nombre or not apellidos or not email:
                    st.error("Por favor completa nombre, apellidos y email")
                elif email != confirmar_email:
                    st.error("Los emails no coinciden")
                elif "@" not in email:
                    st.error("Por favor introduce un email v√°lido")
                else:
                    # Registrar usuario en base de datos
                    try:
                        conn = db.get_conn()
                        cursor = conn.cursor()

                        # Verificar si el email ya existe
                        cursor.execute("SELECT id FROM clients WHERE email = ?", (email,))
                        existing = cursor.fetchone()

                        if existing:
                            st.success("‚úÖ Ya estabas registrado. Accediendo al portal...")
                        else:
                            # Insertar nuevo cliente (combinar nombre y apellidos)
                            full_name = f"{nombre} {apellidos}".strip()
                            cursor.execute("""
                                INSERT INTO clients (name, email, phone, address, created_at)
                                VALUES (?, ?, ?, ?, datetime('now'))
                            """, (full_name, email, telefono, direccion))

                            st.success("‚úÖ Registro completado. Accediendo al portal...")

                        conn.commit()
                        conn.close()

                        # Auto-login
                        st.session_state["client_logged_in"] = True
                        st.session_state["client_email"] = email
                        st.session_state["user_role"] = "buyer"
                        st.session_state["has_transactions"] = False
                        st.session_state["has_properties"] = False
                        st.session_state["just_registered"] = True  # Flag para saber que acabamos de registrarnos
                        st.session_state["registration_success"] = True  # Flag para mostrar opciones despu√©s del formulario

                    except Exception as e:
                        st.error(f"Error en el registro: {e}")

        st.markdown("---")
        st.info("üí° **¬øYa tienes cuenta?** Si has realizado compras anteriores, usa tu email para acceder directamente.")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # MOSTRAR OPCIONES DESPU√âS DE REGISTRO EXITOSO (FUERA DEL FORMULARIO)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if st.session_state.get("registration_success"):
            # Limpiar el flag para no mostrarlo en futuras visitas
            del st.session_state["registration_success"]

            st.success("üéâ **¬°Registro completado exitosamente!**")
            st.balloons()

            # Mensaje informativo claro
            st.info("‚úÖ **Ahora tienes acceso completo a este proyecto y a todo el portal de cliente.**")

            # Opciones claras para el usuario
            col1, col2 = st.columns(2)
            with col1:
                if st.button("üë§ Ir a Mi Panel de Cliente", type="primary", width='stretch'):
                    st.query_params.update({
                        "page": "üë§ Panel de Cliente",
                        "selected_project_v2": project_id
                    })
                    st.rerun()

            with col2:
                if st.button("üîç Seguir Explorando Proyectos", width='stretch'):
                    st.query_params.clear()
                    st.query_params["page"] = "Home"
                    st.rerun()

            st.markdown("---")
            st.markdown("### üéØ ¬øQu√© puedes hacer ahora?")
            st.markdown("‚Ä¢ **Ver todos los detalles** del proyecto (planos, 3D, VR)")
            st.markdown("‚Ä¢ **Comprar proyectos** completos (PDF + CAD)")
            st.markdown("‚Ä¢ **Acceder a tu panel** para gestionar todas tus compras")
            st.markdown("‚Ä¢ **Buscar m√°s proyectos** compatibles con tus necesidades")

            st.markdown("---")

    if client_logged_in and client_email:
        # Si acabamos de registrarnos, ya hemos mostrado las opciones arriba
        just_registered = st.session_state.get("just_registered", False)
        if not just_registered:
            st.success(f"‚úÖ **Bienvenido de vuelta, {client_email}**")
            st.info("üí° **Nota:** Si sales de esta p√°gina, puedes volver a tu portal de cliente desde la p√°gina principal usando tu email registrado.")
        # Si acabamos de registrarnos, limpiar el flag pero continuar mostrando la p√°gina
        else:
            del st.session_state["just_registered"]

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # BOTONES DE COMPRA AL FINAL DEL FLUJO (SOLO PARA USUARIOS LOGUEADOS)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if client_logged_in and client_email:
        st.markdown("---")
        st.markdown("### üõí Comprar este proyecto")

        # === SERVICIOS ADICIONALES PROFESIONALES ===
        st.markdown("#### üèóÔ∏è Servicios Profesionales Adicionales")

        col1, col2 = st.columns(2)

        with col1:
            direccion_obra = st.checkbox("üìç Direcci√≥n de Obra - 1000‚Ç¨", help="Servicio de direcci√≥n t√©cnica durante la ejecuci√≥n de la obra")
            visado_proyecto = st.checkbox("‚úÖ Visado del Proyecto - 500‚Ç¨", help="Tramitaci√≥n y legalizaci√≥n del proyecto ante las autoridades competentes")
            gemelos_digitales = st.checkbox("üè¢ Gemelos Digitales (BIM) - 900‚Ç¨", help="Modelos BIM avanzados y gemelos digitales para gesti√≥n del edificio")

        with col2:
            consultoria_sostenibilidad = st.checkbox("üìä Consultor√≠a de Sostenibilidad - 300‚Ç¨", help="Certificaci√≥n energ√©tica y an√°lisis de sostenibilidad ambiental")
            coordinacion_seguridad = st.checkbox("üîß Coordinaci√≥n SSL - 400‚Ç¨", help="Estudio de Seguridad y Salud Laboral obligatorio")

        # Copias adicionales
        st.markdown("**üìã Copias Adicionales del Proyecto**")
        copias_adicionales = st.number_input("N√∫mero de copias adicionales (200‚Ç¨ cada una)", min_value=0, max_value=10, value=0, step=1,
                                           help="Copias adicionales del PDF/CAD para distribuir a proveedores, contratistas, etc.")

        # C√°lculo del total de servicios adicionales
        total_servicios = 0
        servicios_seleccionados = []

        if direccion_obra:
            total_servicios += 1000
            servicios_seleccionados.append("Direcci√≥n de Obra")
        if visado_proyecto:
            total_servicios += 500
            servicios_seleccionados.append("Visado del Proyecto")
        if gemelos_digitales:
            total_servicios += 900
            servicios_seleccionados.append("Gemelos Digitales (BIM)")
        if consultoria_sostenibilidad:
            total_servicios += 300
            servicios_seleccionados.append("Consultor√≠a Sostenibilidad")
        if coordinacion_seguridad:
            total_servicios += 400
            servicios_seleccionados.append("Coordinaci√≥n SSL")

        total_copias = copias_adicionales * 200
        if copias_adicionales > 0:
            servicios_seleccionados.append(f"{copias_adicionales} Copias Adicionales")

        total_servicios += total_copias

        if total_servicios > 0:
            st.markdown(f"**üí∞ Total Servicios Adicionales: {total_servicios}‚Ç¨**")
            with st.expander("Ver servicios seleccionados"):
                for servicio in servicios_seleccionados:
                    st.write(f"‚Ä¢ {servicio}")

            # Mostrar proveedores disponibles para servicios adicionales
            st.markdown("### üèóÔ∏è Proveedores de Servicios Disponibles")
            proveedores_seleccionados = {}

            for servicio in servicios_seleccionados:
                # Mapear servicios a especialidades
                specialty_map = {
                    "Direcci√≥n de Obra": "direccion_obra",
                    "Visado del Proyecto": "visado",
                    "Gemelos Digitales (BIM)": "bim",
                    "Consultor√≠a Sostenibilidad": "sostenibilidad",
                    "Coordinaci√≥n SSL": "ssl"
                }

                specialty = specialty_map.get(servicio, "")
                if specialty:
                    st.markdown(f"**{servicio}:**")
                    # Buscar proveedores disponibles
                    conn_prov = db_conn()
                    cursor_prov = conn_prov.cursor()
                    cursor_prov.execute("""
                        SELECT id, name, company, experience_years, service_area
                        FROM service_providers
                        WHERE specialty = ? AND service_area LIKE ?
                        ORDER BY experience_years DESC
                    """, (specialty, f"%{project_data.get('location', '').split(',')[-1].strip()}%"))

                    proveedores = cursor_prov.fetchall()
                    conn_prov.close()

                    if proveedores:
                        opciones_proveedores = ["Seleccionar proveedor..."] + [f"{p[1]} ({p[2]}) - {p[3]} a√±os exp." for p in proveedores]
                        proveedor_idx = st.selectbox(
                            f"Seleccionar proveedor para {servicio}",
                            range(len(opciones_proveedores)),
                            format_func=lambda x: opciones_proveedores[x],
                            key=f"prov_{servicio}_{project_id}"
                        )
                        if proveedor_idx > 0:
                            proveedores_seleccionados[servicio] = proveedores[proveedor_idx-1]
                    else:
                        st.warning(f"No hay proveedores disponibles para {servicio} en esta zona")

        st.markdown("---")

        from modules.marketplace.utils import db_conn

        # Verificar si ya compr√≥ este proyecto
        conn_check = db_conn()
        cursor_check = conn_check.cursor()
        cursor_check.execute("SELECT id FROM ventas_proyectos WHERE proyecto_id = ? AND cliente_email = ?", (project_id, client_email))
        ya_compro = cursor_check.fetchone()
        conn_check.close()

        if ya_compro:
            st.success("‚úÖ Ya has adquirido este proyecto")
        else:
            col_buy_pdf, col_buy_cad = st.columns(2)
            with col_buy_pdf:
                precio_total_pdf = project_data['price_memoria'] + total_servicios
                if st.button(f"üìÑ Comprar PDF + Servicios ‚Ç¨{precio_total_pdf}", key=f"buy_pdf_{project_id}", use_container_width=True):
                    with st.spinner("Procesando compra..."):
                        import time
                        time.sleep(1)
                    # Registrar compra con servicios adicionales
                    productos_comprados = f"PDF + {', '.join(servicios_seleccionados)}" if servicios_seleccionados else "PDF"
                    conn_buy = db_conn()
                    cursor_buy = conn_buy.cursor()
                    cursor_buy.execute("""
                        INSERT INTO ventas_proyectos
                        (proyecto_id, cliente_email, nombre_cliente, productos_comprados, total_pagado, metodo_pago, fecha_compra)
                        VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                    """, (project_id, client_email, "Compra directa", productos_comprados, precio_total_pdf, "Simulado"))

                    # Obtener el ID de la venta reci√©n creada
                    venta_id = cursor_buy.lastrowid

                    # Registrar asignaciones de servicios si hay proveedores seleccionados
                    if proveedores_seleccionados:
                        specialty_prices = {
                            "Direcci√≥n de Obra": 1000,
                            "Visado del Proyecto": 500,
                            "Gemelos Digitales (BIM)": 900,
                            "Consultor√≠a Sostenibilidad": 300,
                            "Coordinaci√≥n SSL": 400
                        }

                        for servicio, proveedor in proveedores_seleccionados.items():
                            specialty = {
                                "Direcci√≥n de Obra": "direccion_obra",
                                "Visado del Proyecto": "visado",
                                "Gemelos Digitales (BIM)": "bim",
                                "Consultor√≠a Sostenibilidad": "sostenibilidad",
                                "Coordinaci√≥n SSL": "ssl"
                            }.get(servicio, "")

                            precio_servicio = specialty_prices.get(servicio, 0)

                            cursor_buy.execute("""
                                INSERT INTO service_assignments
                                (venta_id, servicio_tipo, proveedor_id, cliente_email, proyecto_id, precio_servicio, fecha_asignacion)
                                VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                            """, (venta_id, specialty, proveedor[0], client_email, project_id, precio_servicio))

                    conn_buy.commit()
                    conn_buy.close()
                    st.success("üéâ PDF con servicios adicionales comprado exitosamente!")
                    st.rerun()

            with col_buy_cad:
                precio_total_cad = project_data['price_cad'] + total_servicios
                if st.button(f"üñ•Ô∏è Comprar CAD + Servicios ‚Ç¨{precio_total_cad}", key=f"buy_cad_{project_id}", use_container_width=True):
                    with st.spinner("Procesando compra..."):
                        import time
                        time.sleep(1)
                    # Registrar compra con servicios adicionales
                    productos_comprados = f"CAD + {', '.join(servicios_seleccionados)}" if servicios_seleccionados else "CAD"
                    conn_buy = db_conn()
                    cursor_buy = conn_buy.cursor()
                    cursor_buy.execute("""
                        INSERT INTO ventas_proyectos
                        (proyecto_id, cliente_email, nombre_cliente, productos_comprados, total_pagado, metodo_pago, fecha_compra)
                        VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                    """, (project_id, client_email, "Compra directa", productos_comprados, precio_total_cad, "Simulado"))

                    # Obtener el ID de la venta reci√©n creada
                    venta_id = cursor_buy.lastrowid

                    # Registrar asignaciones de servicios si hay proveedores seleccionados
                    if proveedores_seleccionados:
                        specialty_prices = {
                            "Direcci√≥n de Obra": 1000,
                            "Visado del Proyecto": 500,
                            "Gemelos Digitales (BIM)": 900,
                            "Consultor√≠a Sostenibilidad": 300,
                            "Coordinaci√≥n SSL": 400
                        }

                        for servicio, proveedor in proveedores_seleccionados.items():
                            specialty = {
                                "Direcci√≥n de Obra": "direccion_obra",
                                "Visado del Proyecto": "visado",
                                "Gemelos Digitales (BIM)": "bim",
                                "Consultor√≠a Sostenibilidad": "sostenibilidad",
                                "Coordinaci√≥n SSL": "ssl"
                            }.get(servicio, "")

                            precio_servicio = specialty_prices.get(servicio, 0)

                            cursor_buy.execute("""
                                INSERT INTO service_assignments
                                (venta_id, servicio_tipo, proveedor_id, cliente_email, proyecto_id, precio_servicio, fecha_asignacion)
                                VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                            """, (venta_id, specialty, proveedor[0], client_email, project_id, precio_servicio))

                    conn_buy.commit()
                    conn_buy.close()
                    st.success("üéâ CAD con servicios adicionales comprado exitosamente!")
                    st.rerun()

    # Bot√≥n volver
    if st.button("‚Üê Volver al Inicio"):
        st.query_params.clear()
        st.rerun()

    # Detener la ejecuci√≥n para evitar mostrar contenido adicional
    st.stop()


def panel_cliente_v2():
    """Panel de cliente - VERSI√ìN V2 (copia exacta del contenido original)"""
    # modules/marketplace/client_panel.py
    from modules.marketplace.utils import db_conn
    import json
    import os
    from modules.marketplace.compatibilidad import get_proyectos_compatibles

    # Iniciar servidor est√°tico para VR y archivos
    from pathlib import Path
    STATIC_ROOT = Path(r"C:/ARCHIRAPID_PROYECT25")
    STATIC_PORT = _start_static_server(STATIC_ROOT, port=8765)
    if STATIC_PORT:
        STATIC_URL = f"http://localhost:{STATIC_PORT}/"
    else:
        STATIC_URL = "http://localhost:8765/"

    st.title("üë§ Panel de Cliente - ARCHIRAPID V2")

    # Auto-login si viene de query params con owner_email
    if "auto_owner_email" in st.session_state and not st.session_state.get("client_logged_in", False):
        auto_email = st.session_state["auto_owner_email"]
        # Verificar si el email tiene transacciones O es propietario con fincas
        conn = db_conn()
        cursor = conn.cursor()

        # Buscar transacciones (compras/reservas)
        cursor.execute("SELECT * FROM reservations WHERE buyer_email=?", (auto_email,))
        transactions = cursor.fetchall()

        # Si no tiene transacciones, buscar si es propietario con fincas publicadas
        if not transactions:
            cursor.execute("SELECT * FROM plots WHERE owner_email=?", (auto_email,))
            owner_plots = cursor.fetchall()
        else:
            owner_plots = []

        conn.close()

        # Auto-login si tiene transacciones O fincas como propietario
        if transactions or owner_plots:
            st.session_state["client_logged_in"] = True
            st.session_state["client_email"] = auto_email
            st.session_state["user_role"] = "buyer" if transactions else "owner"
            st.session_state["has_transactions"] = len(transactions) > 0
            st.session_state["has_properties"] = len(owner_plots) > 0

            role_text = "comprador" if transactions else "propietario"
            st.info(f"üîÑ Auto-acceso concedido como {role_text} para {auto_email}")

            # Limpiar el estado de auto-login
            del st.session_state["auto_owner_email"]

    # Verificar si viene de vista previa de proyecto
    selected_project = st.query_params.get("selected_project_v2")
    if selected_project and not st.session_state.get("client_logged_in", False):
        st.info("üîç Proyecto seleccionado detectado. Por favor inicia sesi√≥n para continuar.")

    # Login simple por email
    if "client_logged_in" not in st.session_state:
        st.session_state["client_logged_in"] = False

    if not st.session_state["client_logged_in"]:
        st.subheader("üîê Acceso al Panel de Cliente V2")
        st.info("Introduce el email que usaste al realizar tu compra/reserva")

        email = st.text_input("Email de cliente", placeholder="tu@email.com")

        if st.button("Acceder", type="primary"):
            if email:
                # Verificar si el email tiene transacciones, propiedades O est√° registrado como cliente
                conn = db_conn()
                cursor = conn.cursor()

                # Buscar transacciones (compras/reservas)
                cursor.execute("SELECT * FROM reservations WHERE buyer_email=?", (email,))
                transactions = cursor.fetchall()

                # Si no tiene transacciones, buscar si es propietario con fincas publicadas
                if not transactions:
                    cursor.execute("SELECT * FROM plots WHERE owner_email=?", (email,))
                    owner_plots = cursor.fetchall()
                else:
                    owner_plots = []

                # Si no tiene transacciones ni propiedades, verificar si est√° registrado como cliente
                is_registered_client = False
                if not transactions and not owner_plots:
                    cursor.execute("SELECT id, name FROM clients WHERE email = ?", (email,))
                    client_record = cursor.fetchone()
                    is_registered_client = client_record is not None

                conn.close()

                # Permitir acceso si tiene transacciones, fincas como propietario O est√° registrado como cliente
                if transactions or owner_plots or is_registered_client:
                    st.session_state["client_logged_in"] = True
                    st.session_state["client_email"] = email

                    # Determinar el rol basado en la prioridad: transacciones > propiedades > cliente registrado
                    if transactions:
                        user_role = "buyer"
                        role_text = "comprador"
                    elif owner_plots:
                        user_role = "owner"
                        role_text = "propietario"
                    else:
                        # Cliente registrado sin transacciones ni propiedades
                        user_role = "buyer"  # Por defecto buyer para poder comprar proyectos
                        role_text = "cliente registrado"

                    st.session_state["user_role"] = user_role
                    st.session_state["has_transactions"] = len(transactions) > 0
                    st.session_state["has_properties"] = len(owner_plots) > 0

                    st.success(f"‚úÖ Acceso concedido como {role_text} para {email}")
                    st.rerun()
                else:
                    st.error("No se encontraron transacciones, propiedades ni registro para este email")
            else:
                st.error("Por favor introduce tu email")

        st.markdown("---")
        st.info("üí° **Nota:** Si acabas de realizar una compra, usa el email que proporcionaste en el formulario de datos personales.")
        st.info("Por favor inicia sesi√≥n para acceder al panel.")
        # st.stop()  # Comentado para permitir que la p√°gina se cargue

    if st.session_state["client_logged_in"]:
        # Panel de cliente logueado
        client_email = st.session_state.get("client_email")
        user_role = st.session_state.get("user_role", "buyer")
        has_transactions = st.session_state.get("has_transactions", False)
        has_properties = st.session_state.get("has_properties", False)

        # Bot√≥n de cerrar sesi√≥n en sidebar
        with st.sidebar:
            if st.button("üö™ Cerrar Sesi√≥n", key="logout_button_v2"):
                st.session_state["client_logged_in"] = False
                for key in ["client_email", "user_role", "has_transactions", "has_properties", "selected_project_for_panel"]:
                    if key in st.session_state:
                        del st.session_state[key]
                st.rerun()

        # Mostrar rol del usuario
        role_emoji = "üõí" if user_role == "buyer" else "üè†"
        role_text = "Comprador" if user_role == "buyer" else "Propietario"
        # st.success(f"{role_emoji} **Bienvenido/a {role_text}** - {client_email}")

        # üîç MODO 3: Usuario interesado en un proyecto (sin transacciones)
        selected_project_for_panel = st.session_state.get("selected_project_for_panel")
        if user_role == "buyer" and not has_transactions and selected_project_for_panel:
            show_selected_project_panel_v2(client_email, selected_project_for_panel)
            return

        # Contenido diferente seg√∫n el rol
        if user_role == "buyer":
            show_buyer_panel_v2(client_email)
        elif user_role == "owner":
            show_owner_panel_v2(client_email)
        else:
            st.error("Error: No se pudo determinar el tipo de panel apropiado")
            st.stop()


def show_selected_project_panel_v2(client_email: str, project_id: str):
    """Panel para mostrar proyecto seleccionado con detalles completos y opciones de compra - V2"""
    st.subheader("üèóÔ∏è Proyecto Arquitect√≥nico Seleccionado V2")

    # Obtener datos completos del proyecto
    conn = db_conn()
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, title, description, m2_construidos, area_m2, price, estimated_cost,
               price_memoria, price_cad, property_type, foto_principal, galeria_fotos,
               memoria_pdf, planos_pdf, planos_dwg, modelo_3d_glb, vr_tour, energy_rating,
               architect_name, characteristics_json, habitaciones, banos, garaje, plantas,
               m2_parcela_minima, m2_parcela_maxima, certificacion_energetica, tipo_proyecto
        FROM projects
        WHERE id = ?
    """, (project_id,))
    row = cursor.fetchone()

    if not row:
        st.error("‚ùå Proyecto no encontrado")
        conn.close()
        return

    # Extraer datos del proyecto
    project_data = {
        'id': row[0],
        'title': row[1],
        'description': row[2],
        'm2_construidos': row[3],
        'area_m2': row[4],
        'price': row[5],
        'estimated_cost': row[6],
        'price_memoria': row[7] or 1800,
        'price_cad': row[8] or 2500,
        'property_type': row[9],
        'foto_principal': row[10],
        'galeria_fotos': row[11],
        'memoria_pdf': row[12],
        'planos_pdf': row[13],
        'planos_dwg': row[14],
        'modelo_3d_glb': row[15],
        'vr_tour': row[16],
        'energy_rating': row[17],
        'architect_name': row[18],
        'characteristics': json.loads(row[19]) if row[19] else {},
        'habitaciones': row[20],
        'banos': row[21],
        'garaje': row[22],
        'plantas': row[23],
        'm2_parcela_minima': row[24],
        'm2_parcela_maxima': row[25],
        'certificacion_energetica': row[26],
        'tipo_proyecto': row[27]
    }

    # Calcular superficie m√≠nima requerida
    m2_proyecto = project_data['m2_construidos'] or project_data['area_m2'] or 0
    if project_data['m2_parcela_minima']:
        superficie_minima = project_data['m2_parcela_minima']
    else:
        superficie_minima = m2_proyecto / 0.33 if m2_proyecto > 0 else 0

    # T√≠tulo principal
    st.title(f"üèóÔ∏è {project_data['title']}")
    st.markdown(f"**üë®‚Äçüíº Arquitecto:** {project_data['architect_name'] or 'No especificado'}")

    # Galer√≠a completa de fotos
    st.header("üì∏ Galer√≠a Completa del Proyecto")

    # Obtener im√°genes v√°lidas usando la funci√≥n existente
    from modules.marketplace.plot_detail import get_project_images
    project_images = get_project_images({
        'foto_principal': project_data['foto_principal'],
        'galeria_fotos': json.loads(project_data['galeria_fotos']) if isinstance(project_data['galeria_fotos'], str) else project_data['galeria_fotos']
    })

    if project_images:
        # Mostrar im√°genes en grid responsivo
        cols = st.columns(min(len(project_images), 3))
        for idx, img_path in enumerate(project_images):
            with cols[idx % 3]:
                try:
                    st.image(img_path, width='stretch', caption=f"Imagen {idx + 1}")
                except Exception as e:
                    st.warning(f"No se pudo cargar la imagen {idx + 1}")
    else:
        st.info("No hay im√°genes disponibles para este proyecto")

    # Informaci√≥n t√©cnica completa
    st.header("üìã Informaci√≥n T√©cnica Completa")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üè† Caracter√≠sticas Constructivas")
        st.write(f"**Superficie construida:** {m2_proyecto:.0f} m¬≤")
        st.write(f"**Superficie m√≠nima de terreno:** {superficie_minima:.0f} m¬≤")
        if project_data['m2_parcela_maxima']:
            st.write(f"**Superficie m√°xima de terreno:** {project_data['m2_parcela_maxima']:.0f} m¬≤")
        st.write(f"**Tipo:** {project_data['property_type'] or project_data['tipo_proyecto'] or 'Residencial'}")

        # Caracter√≠sticas espec√≠ficas
        if project_data['habitaciones']:
            st.write(f"**Habitaciones:** {project_data['habitaciones']}")
        if project_data['banos']:
            st.write(f"**Ba√±os:** {project_data['banos']}")
        if project_data['plantas']:
            st.write(f"**Plantas:** {project_data['plantas']}")
        if project_data['garaje']:
            st.write(f"**Garaje:** {'S√≠' if project_data['garaje'] else 'No'}")

        # Certificaci√≥n energ√©tica
        if project_data['certificacion_energetica'] or project_data['energy_rating']:
            rating = project_data['certificacion_energetica'] or project_data['energy_rating']
            st.write(f"**Certificaci√≥n energ√©tica:** {rating}")

    with col2:
        st.subheader("üí∞ Informaci√≥n Econ√≥mica")
        if project_data['estimated_cost']:
            st.write(f"**Coste de ejecuci√≥n aproximado:** ‚Ç¨{project_data['estimated_cost']:,.0f}")
        st.write("**Precio descarga proyecto completo:**")
        st.write(f"‚Ä¢ üìÑ PDF (Memoria completa): ‚Ç¨{project_data['price_memoria']}")
        st.write(f"‚Ä¢ üñ•Ô∏è CAD (Planos editables): ‚Ç¨{project_data['price_cad']}")
        total_price = project_data['price_memoria'] + project_data['price_cad']
        st.write(f"‚Ä¢ üí∞ **TOTAL:** ‚Ç¨{total_price}")

    # Descripci√≥n completa
    if project_data['description']:
        st.header("üìù Descripci√≥n del Proyecto")
        st.write(project_data['description'])

    # Caracter√≠sticas adicionales
    if project_data['characteristics']:
        st.header("‚ú® Caracter√≠sticas Adicionales")
        chars = project_data['characteristics']
        if isinstance(chars, dict):
            for key, value in chars.items():
                st.write(f"‚Ä¢ **{key}:** {value}")

    # SISTEMA DE COMPRA
    st.header("üõí Adquirir Proyecto Completo")

    # Verificar si ya compr√≥ este proyecto
    cursor.execute("SELECT id FROM ventas_proyectos WHERE proyecto_id = ? AND cliente_email = ?", (project_id, client_email))
    ya_comprado = cursor.fetchone()
    conn.close()

    if ya_comprado:
        st.success("‚úÖ **Ya has adquirido este proyecto**")
        st.info("Puedes descargar los archivos desde la secci√≥n 'Mis Proyectos'")

        # Mostrar botones de descarga
        col1, col2, col3 = st.columns(3)
        with col1:
            if st.button("üìÑ Descargar Memoria PDF", use_container_width=True, type="primary"):
                st.info("Descarga iniciada... (simulado)")
        with col2:
            if st.button("üñ•Ô∏è Descargar Planos CAD", use_container_width=True, type="primary"):
                st.info("Descarga iniciada... (simulado)")
        with col3:
            if st.button("üèóÔ∏è Descargar Modelo 3D", use_container_width=True, type="primary"):
                st.info("Descarga iniciada... (simulado)")

    else:
        st.info("üí≥ Selecciona el producto que deseas adquirir:")

        col_pdf, col_cad = st.columns(2)

        with col_pdf:
            if st.button(f"üìÑ Comprar Memoria PDF - ‚Ç¨{project_data['price_memoria']}", use_container_width=True, type="primary"):
                # Simular compra directa de PDF
                with st.spinner("Procesando compra de PDF..."):
                    import time
                    time.sleep(1)
                st.success("üéâ **PDF comprado con √©xito!**")
                st.info("üìß Recibir√°s el enlace de descarga por email")

        with col_cad:
            if st.button(f"üñ•Ô∏è Comprar Planos CAD - ‚Ç¨{project_data['price_cad']}", use_container_width=True, type="primary"):
                # Simular compra directa de CAD
                with st.spinner("Procesando compra de CAD..."):
                    import time
                    time.sleep(1)
                st.success("üéâ **CAD comprado con √©xito!**")
                st.info("üìß Recibir√°s el enlace de descarga por email")

    # FINCAS COMPATIBLES DEL USUARIO
    st.header("üè† Fincas Compatibles")

    # Obtener fincas del usuario (compradas o propias)
    conn = db_conn()
    cursor = conn.cursor()

    # Fincas compradas
    cursor.execute("""
        SELECT p.id, p.title, p.surface_m2, p.buildable_m2
        FROM reservations r
        JOIN plots p ON r.plot_id = p.id
        WHERE r.buyer_email = ?
    """, (client_email,))

    fincas_compradas = cursor.fetchall()

    # Fincas propias (si es propietario)
    cursor.execute("""
        SELECT id, title, surface_m2, buildable_m2
        FROM plots
        WHERE owner_email = ?
    """, (client_email,))

    fincas_propias = cursor.fetchall()
    conn.close()

    fincas_usuario = fincas_compradas + fincas_propias

    if fincas_usuario:
        for finca in fincas_usuario:
            finca_id, finca_title, surface_m2, buildable_m2 = finca

            # Calcular superficie edificable
            superficie_edificable = buildable_m2 if buildable_m2 else surface_m2 * 0.33

            # Verificar compatibilidad
            compatible = False
            if m2_proyecto <= superficie_edificable:
                compatible = True

            with st.expander(f"üè† {finca_title} - {'‚úÖ Compatible' if compatible else '‚ùå No compatible'}", expanded=compatible):
                col1, col2 = st.columns(2)

                with col1:
                    st.write(f"**Superficie total:** {surface_m2} m¬≤")
                    st.write(f"**Superficie edificable:** {superficie_edificable:.0f} m¬≤")
                    st.write(f"**Proyecto requiere:** {m2_proyecto:.0f} m¬≤")

                with col2:
                    if compatible:
                        st.success("üéØ **¬°Perfecto match!** Este proyecto cabe en tu finca")
                        if st.button(f"üöÄ Dise√±ar en {finca_title}", key=f"design_v2_{finca_id}", use_container_width=True):
                            st.info("üé® Redirigiendo al dise√±ador... (pr√≥ximamente)")
                    else:
                        deficit = m2_proyecto - superficie_edificable
                        st.warning(f"‚ö†Ô∏è Necesitas {deficit:.0f} m¬≤ m√°s de superficie edificable")
    else:
        st.info("No tienes fincas registradas. Para usar este proyecto, primero compra una finca compatible.")

    # ACCIONES ADICIONALES
    st.header("üéØ ¬øQu√© deseas hacer ahora?")

    col1, col2, col3 = st.columns(3)

    with col1:
        if st.button("üìã Ver M√°s Proyectos", use_container_width=True):
            st.query_params.clear()
            st.query_params["page"] = "üè† HOME"
            st.rerun()

    with col2:
        if st.button("üõí Mi Historial de Compras", use_container_width=True):
            # Limpiar proyecto seleccionado para mostrar panel normal
            if "selected_project_v2" in st.query_params:
                del st.query_params["selected_project_v2"]
            st.rerun()

    with col3:
        if st.button("üìß Contactar Arquitecto", use_container_width=True):
            st.info(f"üìß Contacto: {project_data['architect_name'] or 'Equipo ARCHIRAPID'}")
            st.write("Email: proyectos@archirapid.com")
            st.write("Tel√©fono: +34 900 123 456")


def registro_v2():
    """P√°gina de registro de usuario - Versi√≥n Profesional"""
    st.title("üìù Registro de Usuario - ARCHIRAPID")
    st.info("Reg√≠strate para acceder a todos los proyectos y funcionalidades avanzadas")

    with st.form("registro_simple_v2"):
        col1, col2 = st.columns(2)

        with col1:
            nombre = st.text_input("Nombre", placeholder="Tu nombre")
            apellidos = st.text_input("Apellidos", placeholder="Tus apellidos")
            telefono = st.text_input("Tel√©fono", placeholder="+34 600 000 000")

        with col2:
            email = st.text_input("Email", placeholder="tu@email.com")
            confirmar_email = st.text_input("Confirmar Email", placeholder="tu@email.com")
            direccion = st.text_input("Direcci√≥n", placeholder="Calle, Ciudad, Provincia")

        submitted = st.form_submit_button("üöÄ Registrarme", type="primary", width='stretch')

        if submitted:
            # Validaciones b√°sicas
            if not nombre or not apellidos or not email:
                st.error("Por favor completa nombre, apellidos y email")
            elif email != confirmar_email:
                st.error("Los emails no coinciden")
            elif "@" not in email:
                st.error("Por favor introduce un email v√°lido")
            else:
                # Registrar usuario en base de datos
                try:
                    from src import db
                    conn = db.get_conn()
                    cursor = conn.cursor()

                    # Verificar si el email ya existe
                    cursor.execute("SELECT id FROM clients WHERE email = ?", (email,))
                    existing = cursor.fetchone()

                    if existing:
                        st.info("Ya estabas registrado. Accediendo...")
                    else:
                        # Insertar nuevo cliente (combinar nombre y apellidos)
                        full_name = f"{nombre} {apellidos}".strip()
                        cursor.execute("""
                            INSERT INTO clients (name, email, phone, address, created_at)
                            VALUES (?, ?, ?, ?, datetime('now'))
                        """, (full_name, email, telefono, direccion))

                        st.info("Registro completado. Accediendo...")

                    conn.commit()
                    conn.close()

                    # Auto-login
                    st.session_state["client_logged_in"] = True
                    st.session_state["client_email"] = email
                    st.session_state["user_role"] = "buyer"
                    st.session_state["has_transactions"] = False
                    st.session_state["has_properties"] = False

                    # Si ven√≠a viendo un proyecto espec√≠fico, guardarlo para mostrar los botones de compra
                    if "proyecto_seleccionado" in st.session_state and st.session_state["proyecto_seleccionado"]:
                        project_id = st.session_state["proyecto_seleccionado"].get("id")
                        if project_id:
                            st.session_state["selected_project_for_panel"] = project_id

                    # Redirigir de vuelta al Marketplace con sesi√≥n activa
                    st.query_params["page"] = "üè† Inicio / Marketplace"
                    st.rerun()

                except Exception as e:
                    st.error(f"Error en el registro: {e}")

    st.markdown("---")
    st.info("üí° **¬øYa tienes cuenta?** Si has realizado compras anteriores, accede directamente desde el panel de cliente.")


# === FUNCIONES AUXILIARES V2 ===

def show_buyer_panel_v2(client_email):
    """Panel principal para compradores - V2"""
    st.header("üõí Panel de Comprador V2")

    # Tabs para diferentes secciones
    tab1, tab2, tab3 = st.tabs(["üîç Buscar Proyectos", "üìã Mis Intereses", "üìä Mis Transacciones"])

    with tab1:
        # B√∫squeda avanzada de proyectos
        show_advanced_project_search_v2(client_email)

    with tab2:
        # Mostrar proyectos guardados/interesantes
        show_client_interests_v2(client_email)

    with tab3:
        # Mostrar transacciones realizadas
        show_client_transactions_v2(client_email)


def show_owner_panel_v2(client_email):
    """Panel para propietarios con fincas - V2"""
    st.subheader("üè† Mis Propiedades Publicadas V2")

    # Obtener fincas del propietario
    conn = db_conn()
    cursor = conn.cursor()
    cursor.execute("SELECT id, title, cadastral_ref, surface_m2, buildable_m2, is_urban, vector_geojson, registry_note_path, price, lat, lon, status, created_at, photo_paths, owner_name, owner_email, owner_phone, sanitation_type, plot_type, propietario_direccion FROM plots WHERE owner_email = ? ORDER BY created_at DESC", (client_email,))

    properties = cursor.fetchall()
    conn.close()

    if not properties:
        st.warning("No tienes propiedades publicadas")
        return

    # Mostrar propiedades
    for prop in properties:
        prop_id = prop[0]
        title = prop[1]
        surface_m2 = prop[3]
        price = prop[8]
        status = prop[11]
        created_at = prop[12]
        photo_paths = prop[13]
        owner_name = prop[14]
        owner_phone = prop[16]

        status_emoji = "‚úÖ" if status == "published" else "‚è≥" if status == "pending" else "‚ùå"

        with st.expander(f"{status_emoji} {title} - {surface_m2} m¬≤", expanded=True):
            col1, col2 = st.columns([1, 2])

            with col1:
                # Mostrar imagen de la finca
                if photo_paths:
                    try:
                        paths = json.loads(photo_paths)
                        if paths and isinstance(paths, list):
                            img_path = f"uploads/{paths[0]}"
                            if os.path.exists(img_path):
                                st.image(img_path, width=200)
                    except:
                        st.image("assets/fincas/image1.jpg", width=200)
                else:
                    st.image("assets/fincas/image1.jpg", width=200)

            with col2:
                st.markdown(f"**üè† Propiedad:** {title}")
                st.markdown(f"**üìè Superficie:** {surface_m2} m¬≤")
                st.markdown(f"**üí∞ Precio:** ‚Ç¨{price}")
                st.markdown(f"**üìä Estado:** {status.capitalize()}")
                st.markdown(f"**üìÖ Publicada:** {created_at}")
                st.markdown(f"**üìû Contacto:** {owner_phone}")

                # Estad√≠sticas de la propiedad
                st.markdown("---")
                st.markdown("**üìà Estad√≠sticas:**")

                # Contar propuestas para esta finca
                conn = db_conn()
                cursor = conn.cursor()
                cursor.execute("SELECT COUNT(*) FROM proposals WHERE plot_id = ?", (prop_id,))
                proposals_count = cursor.fetchone()[0]
                conn.close()

                col_stats1, col_stats2 = st.columns(2)
                with col_stats1:
                    st.metric("üì® Propuestas Recibidas", proposals_count)
                with col_stats2:
                    st.metric("üëÅÔ∏è Visitas Estimadas", "N/A")  # TODO: implementar contador de visitas

    # Opciones espec√≠ficas para propietarios
    st.markdown("---")
    st.subheader("üéØ Gesti√≥n de Propiedades V2")

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("#### üìä VER PROPUESTAS")
        st.write("Revisa las propuestas de arquitectos para tus fincas")
        if st.button("üì® Ver Todas las Propuestas", key="view_proposals_owner_v2", use_container_width=True, type="primary"):
            st.success("üì® Mostrando todas las propuestas... (V2)")
            st.info("Aqu√≠ podr√°s gestionar todas las propuestas recibidas para tus propiedades")

    with col2:
        st.markdown("#### ‚ûï PUBLICAR M√ÅS FINCAS")
        st.write("A√±ade m√°s propiedades a tu portafolio")
        if st.button("üè† Subir Nueva Finca", key="upload_new_property_v2", use_container_width=True, type="primary"):
            st.success("üè† Redirigiendo a subida de fincas... (V2)")
            st.info("Accede desde el men√∫ lateral 'Propietarios (Subir Fincas)'")

    show_common_actions_v2(context="owner")


def show_client_interests_v2(client_email):
    """Mostrar proyectos de inter√©s del cliente - V2"""
    st.subheader("‚≠ê Mis Proyectos de Inter√©s V2")

    conn = db_conn()
    cursor = conn.cursor()
    cursor.execute("""
        SELECT ci.project_id, ci.created_at, p.title, p.m2_construidos, p.price, p.foto_principal
        FROM client_interests ci
        JOIN projects p ON ci.project_id = p.id
        WHERE ci.email = ?
        ORDER BY ci.created_at DESC
    """, (client_email,))

    interests = cursor.fetchall()
    conn.close()

    if not interests:
        st.info("No tienes proyectos guardados como de inter√©s. Explora el marketplace para encontrar proyectos que te gusten.")
        return

    # Mostrar proyectos de inter√©s
    for interest in interests:
        project_id, saved_at, title, m2, price, foto = interest

        with st.expander(f"üèóÔ∏è {title}", expanded=True):
            col1, col2 = st.columns([1, 2])

            with col1:
                if foto:
                    try:
                        st.image(foto, width=200)
                    except:
                        st.image("assets/fincas/image1.jpg", width=200)
                else:
                    st.image("assets/fincas/image1.jpg", width=200)

            with col2:
                st.markdown(f"**üèóÔ∏è Proyecto:** {title}")
                st.markdown(f"**üìè Superficie:** {m2} m¬≤" if m2 else "**üìè Superficie:** N/D")
                st.markdown(f"**üí∞ Precio:** ‚Ç¨{price:,.0f}" if price else "**üí∞ Precio:** N/D")
                st.markdown(f"**üìÖ Guardado:** {saved_at}")

                if st.button("Ver Detalles", key=f"view_interest_v2_{project_id}"):
                    st.query_params["selected_project_v2"] = project_id
                    st.rerun()


def show_client_transactions_v2(client_email):
    """Mostrar transacciones del cliente (fincas compradas) - V2"""
    st.subheader("üìã Mis Transacciones V2")

    # Obtener transacciones del cliente
    conn = db_conn()
    cursor = conn.cursor()
    cursor.execute("""
    SELECT r.id, r.plot_id, r.buyer_name, r.amount, r.kind, r.created_at,
           p.title, p.m2, p.price, p.photo_paths
    FROM reservations r
    JOIN plots p ON r.plot_id = p.id
    WHERE r.buyer_email = ?
    ORDER BY r.created_at DESC
""", (client_email,))

    transactions = cursor.fetchall()
    conn.close()

    if not transactions:
        st.info("No se encontraron transacciones para este cliente.")
        return

    # Mostrar tabla general
    st.dataframe(transactions)

    # Mostrar resumen de transacciones
    for trans in transactions:
        trans_id, plot_id, buyer_name, amount, kind, created_at, plot_title, m2, price, photo_paths = trans

        with st.expander(f"üè† {plot_title} - {kind.upper()}", expanded=True):
            col1, col2 = st.columns([1, 2])

            # üì∏ Columna izquierda: imagen
            with col1:
                if photo_paths:
                    try:
                        paths = json.loads(photo_paths)
                        if paths and isinstance(paths, list):
                            image_paths = [f"uploads/{path}" for path in paths]
                            st.image(image_paths, caption=["Foto " + str(i+1) for i in range(len(image_paths))], use_container_width=True)
                    except Exception as e:
                        st.warning(f"No se pudo cargar la imagen: {e}")

            # üìã Columna derecha: detalles
            with col2:
                st.markdown(f"**üìã ID Transacci√≥n:** `{trans_id}`")
                st.markdown(f"**üè† Finca:** {plot_title}")
                st.markdown(f"**üìè Superficie:** {m2} m¬≤")
                st.markdown(f"**üí∞ Precio Total:** ‚Ç¨{price}")
                st.markdown(f"**üíµ Cantidad Pagada:** ‚Ç¨{amount}")
                st.markdown(f"**üìÖ Fecha:** {created_at}")
                st.markdown(f"**‚úÖ Tipo:** {kind.upper()}")

        # üîç PROYECTOS COMPATIBLES
        st.markdown("### üìê Proyectos Compatibles")

        proyectos = get_proyectos_compatibles(plot_id)

        if not proyectos:
            st.info("No hay proyectos compatibles para esta finca.")
        else:
            for p in proyectos:
                st.markdown(f"**üèóÔ∏è {p.get('nombre', 'Proyecto sin nombre')}** ‚Äî {p.get('total_m2', '?')} m¬≤")

                img = p.get("imagen_principal")
                if img:
                    st.image(f"assets/projects/{img}", use_container_width=True)

                st.markdown("---")

        show_common_actions_v2(context=f"buyer_{trans_id}")  # Acciones comunes para compradores


def show_common_actions_v2(context="common"):
    """Acciones comunes para compradores y propietarios - V2"""
    st.markdown("---")

    # Opciones de acci√≥n
    st.subheader("üéØ ¬øQu√© deseas hacer? V2")

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("#### üè° DISE√ëAR VIVIENDA")
        st.write("Crea tu casa ideal con nuestros arquitectos")
        if st.button("üöÄ Ir al Dise√±ador", key=f"go_designer_panel_2_{context}", use_container_width=True, type="primary"):
            st.success("üé® Redirigiendo al Dise√±ador de Vivienda... (V2)")
            st.info("En esta secci√≥n podr√°s dise√±ar tu vivienda personalizada")

    with col2:
        st.markdown("#### üìê VER PROYECTOS")
        st.write("Explora proyectos compatibles con tu finca")
        if st.button("üìã Ver Proyectos", key=f"go_projects_panel_{context}", use_container_width=True, type="primary"):
            st.success("üìê Mostrando proyectos disponibles... (V2)")
            st.info("Aqu√≠ ver√°s todos los proyectos arquitect√≥nicos compatibles")

    st.markdown("---")

    # Opciones adicionales
    st.subheader("üîß Opciones Adicionales V2")

    col_a, col_b, col_c = st.columns(3)

    with col_a:
        if st.button("üó∫Ô∏è Volver al Marketplace", key=f"back_to_marketplace_{context}", use_container_width=True):
            st.success("üè† Volviendo al marketplace... (V2)")
            st.info("Puedes seguir explorar m√°s fincas y proyectos")

    with col_b:
        if st.button("üìß Contactar Soporte", key=f"contact_support_{context}", use_container_width=True):
            st.info("üìß Contacto con soporte:")
            st.write("**Email:** soporte@archirapid.com")
            st.write("**Tel√©fono:** +34 900 123 456")

    with col_c:
        if st.button("üìÑ Descargar Documentaci√≥n", key=f"download_docs_{context}", use_container_width=True):
            st.info("üìÑ Descarga disponible pr√≥ximamente")
            st.write("Pronto podr√°s descargar todos los documentos de tu transacci√≥n")


def show_advanced_project_search_v2(client_email):
    """B√∫squeda avanzada de proyectos por criterios - V2"""
    st.subheader("üîç Buscar Proyectos Arquitect√≥nicos V2")
    st.write("Encuentra proyectos compatibles con tus necesidades espec√≠ficas")

    # Formulario de b√∫squeda
    with st.form("advanced_search_form_v2"):
        st.markdown("### üéØ Especifica tus criterios")

        col1, col2 = st.columns(2)

        with col1:
            presupuesto_max = st.number_input(
                "üí∞ Presupuesto m√°ximo (‚Ç¨)",
                min_value=0,
                value=0,
                step=10000,
                help="Precio m√°ximo que est√°s dispuesto a pagar por el proyecto completo"
            )

            area_deseada = st.number_input(
                "üìê √Årea de construcci√≥n deseada (m¬≤)",
                min_value=0,
                value=0,
                step=10,
                help="Superficie aproximada que quieres construir (¬±20% tolerancia)"
            )

        with col2:
            parcela_disponible = st.number_input(
                "üèûÔ∏è Parcela disponible (m¬≤)",
                min_value=0,
                value=0,
                step=50,
                help="Tama√±o de terreno que tienes disponible"
            )

            # Checkbox para buscar solo proyectos que quepan
            solo_compatibles = st.checkbox(
                "Solo proyectos que quepan en mi parcela",
                value=True,
                help="Filtrar proyectos cuya parcela m√≠nima sea ‚â§ a tu terreno disponible"
            )

        # Bot√≥n de b√∫squeda
        submitted = st.form_submit_button("üîç Buscar Proyectos", type="primary", width='stretch')

    # Mostrar proyectos disponibles (todos al inicio, filtrados si se busc√≥)
    search_params = {'client_email': client_email}  # Par√°metros por defecto

    # Si se hizo una b√∫squeda, usar esos par√°metros
    if 'last_search_params_v2' in st.session_state:
        search_params = st.session_state['last_search_params_v2']

    # Buscar proyectos
    with st.spinner("Cargando proyectos..."):
        proyectos = get_proyectos_compatibles(**search_params)

    # Mostrar contador
    st.markdown(f"### üèóÔ∏è Proyectos Disponibles: {len(proyectos)}")

    if not proyectos:
        st.info("No hay proyectos disponibles en este momento.")
        return

    # Formulario de b√∫squeda (siempre visible)
    with st.expander("üîç Filtrar Proyectos", expanded=False):
        with st.form("advanced_search_form_v2"):
            st.markdown("### üéØ Especifica tus criterios")

            col1, col2 = st.columns(2)

            with col1:
                presupuesto_max = st.number_input(
                    "üí∞ Presupuesto m√°ximo (‚Ç¨)",
                    min_value=0,
                    value=0,
                    step=10000,
                    help="Precio m√°ximo que est√°s dispuesto a pagar por el proyecto completo"
                )

                area_deseada = st.number_input(
                    "üìê √Årea de construcci√≥n deseada (m¬≤)",
                    min_value=0,
                    value=0,
                    step=10,
                    help="Superficie aproximada que quieres construir (¬±20% tolerancia)"
                )

            with col2:
                parcela_disponible = st.number_input(
                    "üèûÔ∏è Parcela disponible (m¬≤)",
                    min_value=0,
                    value=0,
                    step=50,
                    help="Tama√±o de terreno que tienes disponible"
                )

                # Checkbox para buscar solo proyectos que quepan
                solo_compatibles = st.checkbox(
                    "Solo proyectos que quepan en mi parcela",
                    value=True,
                    help="Filtrar proyectos cuya parcela m√≠nima sea ‚â§ a tu terreno disponible"
                )

            # Bot√≥n de b√∫squeda
            submitted = st.form_submit_button("üîç Aplicar Filtros", type="primary", width='stretch')

        if submitted:
            # Preparar par√°metros de b√∫squeda
            search_params = {
                'client_budget': presupuesto_max if presupuesto_max > 0 else None,
                'client_desired_area': area_deseada if area_deseada > 0 else None,
                'client_parcel_size': parcela_disponible if parcela_disponible > 0 and solo_compatibles else None,
                'client_email': client_email
            }
            st.session_state['last_search_params_v2'] = search_params

            # Mostrar criterios aplicados
            st.markdown("### üìã Filtros aplicados:")
            criterios = []
            if search_params['client_budget']:
                criterios.append(f"üí∞ Presupuesto ‚â§ ‚Ç¨{search_params['client_budget']:,}")
            if search_params['client_desired_area']:
                criterios.append(f"üìê √Årea ‚âà {search_params['client_desired_area']} m¬≤ (¬±20%)")
            if search_params['client_parcel_size']:
                criterios.append(f"üèûÔ∏è Parcela ‚â• {search_params['client_parcel_size']} m¬≤")

            if criterios:
                for criterio in criterios:
                    st.write(f"‚Ä¢ {criterio}")
            else:
                st.info("Mostrando todos los proyectos")

            # Re-buscar con filtros
            with st.spinner("Aplicando filtros..."):
                proyectos = get_proyectos_compatibles(**search_params)
            st.markdown(f"### üèóÔ∏è Resultados filtrados: {len(proyectos)} proyectos")

    # Mostrar proyectos en grid
    cols = st.columns(2)
    for idx, proyecto in enumerate(proyectos):
        with cols[idx % 2]:
            # Tarjeta de proyecto
            with st.container():
                # Imagen
                foto = proyecto.get('foto_principal')
                if foto:
                    try:
                        st.image(foto, width=250, caption=proyecto['title'])
                    except:
                        st.image("assets/fincas/image1.jpg", width=250, caption=proyecto['title'])
                else:
                    st.image("assets/fincas/image1.jpg", width=250, caption=proyecto['title'])

                # Informaci√≥n b√°sica
                st.markdown(f"**üèóÔ∏è {proyecto['title']}**")
                st.write(f"üìê **√Årea:** {proyecto.get('m2_construidos', proyecto.get('area_m2', 'N/D'))} m¬≤")
                st.write(f"üí∞ **Precio:** ‚Ç¨{proyecto.get('price', 0):,.0f}" if proyecto.get('price') else "üí∞ **Precio:** Consultar")

                # Arquitecto
                if proyecto.get('architect_name'):
                    st.write(f"üë®‚Äçüíº **Arquitecto:** {proyecto['architect_name']}")

                # Compatibilidad (si hay filtros aplicados)
                if 'last_search_params_v2' in st.session_state and st.session_state['last_search_params_v2'].get('client_parcel_size'):
                    parcel_size = st.session_state['last_search_params_v2']['client_parcel_size']
                    if proyecto.get('m2_parcela_minima'):
                        if proyecto['m2_parcela_minima'] <= parcel_size:
                            st.success("‚úÖ Compatible con tu parcela")
                        else:
                            st.warning(f"‚ö†Ô∏è Necesita parcela ‚â• {proyecto['m2_parcela_minima']} m¬≤")

                # Bot√≥n de detalles
                if st.button("Ver Detalles", key=f"search_detail_v2_{proyecto['id']}", use_container_width=True):
                    st.query_params["selected_project_v2"] = proyecto['id']
                    st.rerun()

                # Botones de compra directa (si est√° logueado)
                if st.session_state.get("client_logged_in", False):
                    # Verificar si ya compr√≥ este proyecto
                    conn_check = db_conn()
                    cursor_check = conn_check.cursor()
                    cursor_check.execute("SELECT id FROM ventas_proyectos WHERE proyecto_id = ? AND cliente_email = ?", (proyecto['id'], client_email))
                    ya_compro = cursor_check.fetchone()
                    conn_check.close()

                    if ya_compro:
                        st.success("‚úÖ Ya adquirido")
                    else:
                        # Botones de compra
                        col_buy_pdf, col_buy_cad = st.columns(2)
                        with col_buy_pdf:
                            if st.button(f"üìÑ PDF ‚Ç¨{proyecto.get('price_memoria', 1800)}", key=f"buy_pdf_{proyecto['id']}", use_container_width=True):
                                # Simular compra de PDF
                                with st.spinner("Procesando compra..."):
                                    import time
                                    time.sleep(1)
                                # Registrar compra
                                conn_buy = db_conn()
                                cursor_buy = conn_buy.cursor()
                                cursor_buy.execute("""
                                    INSERT INTO ventas_proyectos
                                    (proyecto_id, cliente_email, nombre_cliente, productos_comprados, total_pagado, metodo_pago, fecha_compra)
                                    VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                                """, (proyecto['id'], client_email, "Compra directa", "PDF", proyecto.get('price_memoria', 1800), "Simulado"))
                                conn_buy.commit()
                                conn_buy.close()
                                st.success("üéâ PDF comprado!")
                                st.rerun()

                        with col_buy_cad:
                            if st.button(f"üñ•Ô∏è CAD ‚Ç¨{proyecto.get('price_cad', 2500)}", key=f"buy_cad_{proyecto['id']}", use_container_width=True):
                                # Simular compra de CAD
                                with st.spinner("Procesando compra..."):
                                    import time
                                    time.sleep(1)
                                # Registrar compra
                                conn_buy = db_conn()
                                cursor_buy = conn_buy.cursor()
                                cursor_buy.execute("""
                                    INSERT INTO ventas_proyectos
                                    (proyecto_id, cliente_email, nombre_cliente, productos_comprados, total_pagado, metodo_pago, fecha_compra)
                                    VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
                                """, (proyecto['id'], client_email, "Compra directa", "CAD", proyecto.get('price_cad', 2500), "Simulado"))
                                conn_buy.commit()
                                conn_buy.close()
                                st.success("üéâ CAD comprado!")
                                st.rerun()

                st.markdown("---")


# === NUEVAS RUTAS V2 (BORR√ìN Y CUENTA NUEVA) ===
if "selected_project_v2" in params and not page_from_query:
    try:
        project_id = params["selected_project_v2"]
        detalles_proyecto_v2(project_id)
    except Exception as e:
        st.error(f"Error mostrando detalles del proyecto v2: {e}")
    st.stop()  # Detener la ejecuci√≥n para no mostrar el resto de la app

if page_from_query == "üë§ Panel de Cliente":
    try:
        panel_cliente_v2()
        st.stop()
    except Exception as e:
        st.error(f"Error mostrando panel cliente v2: {e}")

if page_from_query == "Registro de Usuario":
    try:
        registro_v2()
        st.stop()
    except Exception as e:
        st.error(f"Error mostrando registro v2: {e}")


# Page configuration and navigation - SIMPLIFIED VERSION
PAGES = {
    "üè† Inicio / Marketplace": ("modules.marketplace.marketplace", "main"),
    "Intranet": ("modules.marketplace.intranet", "main"),
    "üë§ Panel de Proveedor": ("modules.marketplace.service_providers", "show_service_provider_panel"),
    "üìù Registro de Proveedor de Servicios": ("modules.marketplace.service_providers", "show_service_provider_registration"),
    "Arquitectos (Marketplace)": ("modules.marketplace.marketplace_upload", "main"),
    "üë§ Panel de Cliente": ("modules.marketplace.client_panel_fixed", "main"),
    "Iniciar Sesi√≥n": ("modules.marketplace.auth", "show_login"),
    "Registro de Usuario": ("modules.marketplace.auth", "show_registration"),
}
PAGES = list(PAGES.keys())

# Helper: start a simple static server for local assets (with CORS)
def _start_static_server(root_dir: Path, port: int = 8765):
    # If already started, return existing port
    if st.session_state.get("static_server_started"):
        return st.session_state.get("static_server_port")
    try:
        class CORSRequestHandler(http.server.SimpleHTTPRequestHandler):
            def end_headers(self):
                self.send_header('Access-Control-Allow-Origin', '*')
                self.send_header('Access-Control-Allow-Methods', 'GET, OPTIONS')
                self.send_header('Access-Control-Allow-Headers', '*')
                super().end_headers()
            def do_OPTIONS(self):
                self.send_response(200, "OK")
                self.send_header('Access-Control-Allow-Origin', '*')
                self.send_header('Access-Control-Allow-Methods', 'GET, OPTIONS')
                self.send_header('Access-Control-Allow-Headers', '*')
                self.end_headers()

        Handler = functools.partial(CORSRequestHandler, directory=str(root_dir))
        httpd = socketserver.ThreadingTCPServer(("0.0.0.0", port), Handler)
    except Exception:
        return None
    thread = threading.Thread(target=httpd.serve_forever, daemon=True)
    thread.start()
    st.session_state["static_server_started"] = True
    st.session_state["static_server_port"] = port
    st.session_state["static_server_obj"] = httpd
    return port


def render_portal_cliente_proyecto():
    from modules.marketplace.utils import db_conn
    st.header("üìÇ Portal de Cliente ‚Äî Proyecto Seleccionado")

    proyecto = st.session_state.get("proyecto_seleccionado")
    interes_id = st.session_state.get("interes_proyecto_id")
    interes_titulo = st.session_state.get("interes_proyecto_titulo")
    email = st.session_state.get("email", "")
    rol = st.session_state.get("role", "cliente")  # futuro: cliente / propietario / arquitecto / admin

    if not proyecto and not interes_id:
        st.warning("No hay ning√∫n proyecto seleccionado para mostrar en el portal de cliente.")
        return

    st.markdown("### üè° Informaci√≥n del Proyecto")

    if proyecto:
        st.write(f"**T√≠tulo:** {proyecto.get('title', 'N/D')}")
        st.write(f"**üí∞ Precio:** {proyecto.get('price', 'N/D')} ‚Ç¨")
        st.write(f"**üìê Superficie:** {proyecto.get('m2_construidos', 'N/D')} m¬≤")
        st.write(f"**üõèÔ∏è Habitaciones:** {proyecto.get('habitaciones', 'N/D')}")
        st.write(f"**üõÅ Ba√±os:** {proyecto.get('banos', 'N/D')}")
        st.write(f"**üè† Plantas:** {proyecto.get('plantas', 'N/D')}")
    else:
        st.warning("No hay proyecto seleccionado.")

    st.markdown("---")

    # VISUALIZACIONES (pesta√±as: 3D / VR / Fotos)
    st.markdown("### üèóÔ∏è Visualizaciones del Proyecto")

    tab_3d, tab_vr, tab_fotos = st.tabs(["üé• 3D", "ü•Ω VR", "üñºÔ∏è Fotos / Planos"])

    # --- Pesta√±a 3D ---
    with tab_3d:
        st.markdown("#### üé• Visor 3D del Proyecto")

        if proyecto:
            # Usamos GLB siempre que exista
            glb_path = proyecto.get("modelo_3d_glb")

            if glb_path:
                rel_path = str(glb_path).replace("\\", "/").lstrip("/")
                # Obtener STATIC_URL si est√° definido, si no usar fallback
                STATIC_URL = globals().get('STATIC_URL', 'http://127.0.0.1:8765/')
                model_url = f"{STATIC_URL}{rel_path}".replace(" ", "%20")

                try:
                    html_final = three_html_for(model_url, str(proyecto.get("id")))
                    st.components.v1.html(html_final, height=700, scrolling=False)
                except Exception as e:
                    st.error(f"Error cargando visor 3D: {e}")
            else:
                st.info("Este proyecto no tiene modelo GLB. Pr√≥ximamente convertiremos OBJ a GLB autom√°ticamente.")
        else:
            st.warning("No hay proyecto seleccionado en el portal.")

    # --- Pesta√±a VR ---
    with tab_vr:
        st.markdown("#### ü•Ω Visor de Realidad Virtual")

        model_glb = None
        if proyecto and proyecto.get("modelo_3d_glb"):
            model_glb = proyecto.get("modelo_3d_glb")

        if model_glb:
            rel = str(model_glb).replace("\\", "/").lstrip("/")
            glb_url = f"http://localhost:8765/{rel}".replace(" ", "%20") + "?v=123"
            viewer_url = f"http://localhost:8765/static/vr_viewer.html?model={glb_url}"

            st.markdown(
                f'<iframe src="{viewer_url}" width="100%" height="600" allow="accelerometer; gyroscope; xr-spatial-tracking; vr" frameborder="0"></iframe>',
                unsafe_allow_html=True,
            )
            st.caption("Visor VR integrado. Si no funciona, verifica permisos del navegador.")
        else:
            st.info("Este proyecto todav√≠a no tiene modelo VR asociado. Usaremos el modelo 3D como base en futuras versiones.")

    # --- Pesta√±a Fotos / Planos ---
    with tab_fotos:
        st.markdown("#### üñºÔ∏è Galer√≠a de Fotos y Planos")

        # Foto principal
        foto = proyecto.get("foto_principal")
        if foto:
            rel = foto.replace("\\", "/").lstrip("/")
            url = f"{globals().get('STATIC_URL','http://127.0.0.1:8765/')}{rel}"
            st.image(url, width=400)

        # Imagen adicional dentro de characteristics_json
        try:
            import json
            chars = json.loads(proyecto.get("characteristics_json", "{}"))
            img2 = chars.get("imagenes")
            # Evitar duplicados
            if img2 and img2 == foto:
                img2 = None
            if img2:
                rel2 = img2.replace("\\", "/").lstrip("/")
                url2 = f"{globals().get('STATIC_URL','http://127.0.0.1:8765/')}{rel2}"
                st.image(url2, width=400)
        except:
            pass

        # Galer√≠a completa
        galeria_fotos = proyecto.get('files', {}).get('fotos', [])
        if galeria_fotos:
            st.subheader("Galer√≠a Completa")
            for foto in galeria_fotos:
                if foto and isinstance(foto, str) and not foto.isdigit() and foto.strip():
                    rel = foto.replace("\\", "/").lstrip("/")
                    url = f"{globals().get('STATIC_URL','http://127.0.0.1:8765/')}{rel}"
                    st.image(url, width=300)

    st.markdown("---")
    st.markdown("### üõí Acciones del Cliente")
    col1, col2 = st.columns(2)
    with col1:
        if st.button("üõí COMPRAR ESTE PROYECTO (simulado)", key="btn_comprar_proyecto_portal"):
            st.success("Simulando compra. Nuestro equipo comercial se pondr√° en contacto contigo.")
    with col2:
        if st.button("üìû QUIERO QUE ME LLAMEN", key="btn_llamar_proyecto_portal"):
            st.success("Hemos registrado tu inter√©s para que te llame el equipo comercial.")

    st.caption(f"Portal vinculado al email: {email or 'No registrado'}")

    st.markdown("---")
    st.markdown("### üîß M√≥dulos Profesionales (Futuro)")
    st.info("Estos m√≥dulos estar√°n disponibles en futuras versiones para monetizaci√≥n:")
    st.write("- üé® Decoradores (packs de interiorismo)")
    st.write("- üèóÔ∏è Constructores (presupuestos autom√°ticos)")
    st.write("- üß± Prefabricadas (cat√°logo integrado)")
    st.write("- üõ°Ô∏è Aseguradoras (p√≥lizas vinculadas)")
    st.write("- üß∞ Materiales de construcci√≥n (marketplace)")
    st.write("- üßë‚Äçüíº Arquitectos (gesti√≥n avanzada)")
    st.write("- üßë‚Äçüíº Propietarios (seguimiento de obra)")



# L√≥gica de navegaci√≥n robusta

# El sidebar DEBE leer de session_state obligatoriamente
selected_page = st.sidebar.radio(
    "Navegaci√≥n",
    options=PAGES,
    index=PAGES.index(st.session_state['selected_page']) if st.session_state['selected_page'] in PAGES else 0
)

# Sincronizamos por si el usuario cambia el radio manualmente
st.session_state['selected_page'] = selected_page

# L√≥gica de Redirecci√≥n
if st.session_state.get('selected_page') == "üè† Inicio / Marketplace":
    st.query_params.clear()
elif st.session_state.get('selected_page') in ["üë§ Panel de Proveedor", "üìù Registro de Proveedor de Servicios"]:
    st.query_params["page"] = st.session_state.get('selected_page')

# Inicializar vista_actual si no existe (no altera comportamiento por defecto)
if "vista_actual" not in st.session_state:
    st.session_state["vista_actual"] = None

# Obtener rol del usuario actual para mostrar botones condicionalmente
current_user_role = None
client_logged_in = st.session_state.get("client_logged_in", False)
client_email = st.session_state.get("client_email", "")

if client_logged_in and client_email:
    try:
        from modules.marketplace.utils import get_user_by_email
        user_data = get_user_by_email(client_email)
        if user_data:
            current_user_role = user_data.get('role')
    except:
        current_user_role = None

# REMOVED: Conditional sidebar buttons for service providers - navigation is now simplified



# Only handle Home here; other pages delegate to modules
if st.session_state.get('selected_page') == "üè† Inicio / Marketplace":
    STATIC_ROOT = Path(r"C:/ARCHIRAPID_PROYECT25")
    STATIC_PORT = _start_static_server(STATIC_ROOT, port=8765)
    # URL base del servidor est√°tico (definida temprano para usar en el header de diagn√≥stico)
    if STATIC_PORT:
        STATIC_URL = f"http://localhost:{STATIC_PORT}/"
    else:
        STATIC_URL = "http://localhost:8765/"

    # Header
    with st.container():
        try:
            from components.header import render_header
            cols = render_header()
            access_col = cols[2]
        except Exception:
            cols = st.columns([1, 4, 1])
            with cols[0]:
                try:
                    st.image("assets/branding/logo.png", width=140)
                except Exception:
                    st.markdown("# üèóÔ∏è ARCHIRAPID")
            with cols[1]:
                st.markdown("### IA Avanzada + Precios en Vivo + Exportaci√≥n Profesional")
            access_col = cols[2]

        with access_col:
            if st.button("üîë Acceder", key="btn_acceder"):
                if st.session_state.get('rol') == 'admin':
                    st.session_state['selected_page'] = 'Intranet'
                    st.rerun()
                else:
                    st.session_state['show_role_selector'] = True
                    st.rerun()

# ========== HOME: LANDING + MARKETPLACE + PROYECTOS ==========

    # Mostrar formulario de login si viewing_login es True
    if st.session_state.get('viewing_login', False):
        st.markdown("---")
        st.header(f"üîê Iniciar Sesi√≥n - {st.session_state.get('login_role', '').title()}")
        
        with st.form("login_form"):
            email = st.text_input("üìß Email", key="login_email")
            password = st.text_input("üîí Contrase√±a", type="password", key="login_password")
            
            col1, col2 = st.columns(2)
            with col1:
                submitted = st.form_submit_button("üöÄ Entrar", type="primary")
            with col2:
                if st.form_submit_button("‚¨ÖÔ∏è Volver al selector"):
                    st.session_state['viewing_login'] = False
                    st.session_state['show_role_selector'] = True
                    st.rerun()
        
        if submitted:
            if not email or not password:
                st.error("Por favor, completa todos los campos.")
            else:
                # Verificar credenciales en la base de datos
                conn = _db.get_conn()
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT id, email, rol, nombre FROM users 
                    WHERE email = ? AND password = ? AND rol = ?
                """, (email, password, st.session_state.get('login_role')))
                user = cursor.fetchone()
                conn.close()
                
                if user:
                    # Login exitoso
                    st.session_state['user_id'] = user[0]
                    st.session_state['user_email'] = user[1]
                    st.session_state['rol'] = user[2]
                    st.session_state['user_name'] = user[3]
                    st.session_state['logged_in'] = True
                    st.session_state['viewing_login'] = False
                    st.session_state['show_role_selector'] = False
                    
                    # Redirigir seg√∫n el rol
                    if st.session_state['rol'] == 'client':
                        st.session_state['selected_page'] = "üë§ Panel de Cliente"
                    elif st.session_state['rol'] == 'architect':
                        st.session_state['selected_page'] = "Arquitectos (Marketplace)"
                    elif st.session_state['rol'] == 'services':
                        st.session_state['selected_page'] = "üë§ Panel de Proveedor"
                    elif st.session_state['rol'] == 'admin':
                        st.session_state['selected_page'] = "Intranet"
                    
                    st.success(f"¬°Bienvenido {user[3]}!")
                    st.rerun()
                else:
                    st.error("Credenciales incorrectas o rol no coincide.")
        
        st.stop()  # Detener el resto de la Home

    if st.session_state.get('show_role_selector', False):
        # Pantalla de Selector de Rol
        st.markdown("---")
        st.header("üîê Selecciona tu Perfil de Acceso")
        st.markdown("Elige el tipo de usuario que eres para acceder a las funcionalidades correspondientes.")

        col1, col2, col3 = st.columns(3)

        with col1:
            st.markdown("### üè† Soy Cliente/Propietario")
            st.markdown("Accede a tus proyectos y visor 3D.")
            if st.button("üîë Acceso Clientes", key="select_client", use_container_width=True):
                st.session_state['login_role'] = 'client'
                st.session_state['viewing_login'] = True
                st.rerun()

        with col2:
            st.markdown("### üèóÔ∏è Soy Arquitecto")
            st.markdown("Gestiona tus dise√±os y fincas.")
            if st.button("üîë Acceso Arquitectos", key="select_architect", use_container_width=True):
                st.session_state['login_role'] = 'architect'
                st.session_state['viewing_login'] = True
                st.rerun()

        with col3:
            st.markdown("### üõ†Ô∏è Soy Profesional")
            st.markdown("Gestiona tus servicios y obras.")
            if st.button("üîë Acceso Profesionales", key="select_professional", use_container_width=True):
                st.session_state['login_role'] = 'services'
                st.session_state['viewing_login'] = True
                st.rerun()
            if st.button("Reg√≠strate aqu√≠", key="register_here"):
                st.session_state['selected_page'] = "üìù Registro de Proveedor de Servicios"
                st.rerun()

        # Bot√≥n discreto para admin
        st.markdown("---")
        col_admin = st.columns([10, 1])[1]
        with col_admin:
            if st.button("üîê Admin", key="admin_access"):
                st.session_state['login_role'] = 'admin'
                st.session_state['viewing_login'] = True
                st.rerun()

        # Bot√≥n para volver
        st.markdown("---")
        if st.button("‚¨ÖÔ∏è Volver", key="back_to_home"):
            st.session_state['show_role_selector'] = False
            st.rerun()
        st.stop()  # Detenemos el resto de la Home

    else:
        # PASO 1: Renderizar MARKETPLACE (contiene las tarjetas de acceso)
        try:
            from modules.marketplace import marketplace
            marketplace.main()
        except Exception as e:
            import traceback
            st.error(f"‚ùå Error cargando marketplace:  {e}")
            st.code(traceback.format_exc())

        # PASO 3: Renderizar PROYECTOS ARQUITECT√ìNICOS
        st.markdown("---")
        st.header("üèóÔ∏è Proyectos Arquitect√≥nicos Disponibles")

        try:
            from src import db
            projects = db.get_featured_projects(limit=6)
            
            if projects: 
                cols = st.columns(3)
                for idx, p in enumerate(projects):
                    with cols[idx % 3]:
                        # Usar la misma l√≥gica que en plot_detail.py para obtener im√°genes v√°lidas
                        from modules.marketplace.plot_detail import get_project_images
                        
                        # Convertir el formato del proyecto para que sea compatible con get_project_images
                        proyecto_compat = {
                            'foto_principal': p.get('files', {}).get('fotos', [])[0] if p.get('files', {}).get('fotos') else None,
                            'galeria_fotos': p.get('files', {}).get('fotos', [])[1:] if p.get('files', {}).get('fotos') else []
                        }
                        
                        project_images = get_project_images(proyecto_compat)
                        thumbnail = project_images[0] if project_images else "assets/fincas/image1.jpg"
                        
                        st.image(thumbnail, width=250)
                        st.subheader(p.get('title', 'Proyecto'))
                        st.write(f"**‚Ç¨{p.get('price', 0):,.0f}** | {p.get('area_m2', 0)} m¬≤")
                        if st.button("DETALLES (v2)", key=f"proj_home_{p['id']}"):
                            # Abrir en "nueva ventana" usando query params V2
                            st.query_params["selected_project_v2"] = p['id']
                            st.rerun()
            else:
                st.info("No hay proyectos arquitect√≥nicos disponibles a√∫n.")
        except Exception as e:
            st.error(f"Error cargando proyectos: {e}")

    # Banner de captaci√≥n para profesionales
    st.markdown("---")
    with st.container():
        col1, col2 = st.columns([3, 1])
        with col1:
            st.markdown("""
            <div style="background-color: #f0f8ff; padding: 20px; border-radius: 10px; border-left: 5px solid #007bff;">
                <h3 style="color: #007bff; margin-top: 0;">¬øEres profesional de la construcci√≥n o reformas?</h3>
                <p style="margin-bottom: 0;">√önete a nuestra red de proveedores y conecta con clientes que necesitan tus servicios.</p>
            </div>
            """, unsafe_allow_html=True)
        with col2:
            if st.button("Registrarme como Profesional", key="register_professional"):
                st.session_state['selected_page'] = "üìù Registro de Proveedor de Servicios"
                st.rerun()

    # Bot√≥n para buscar profesionales
    st.markdown("---")
    col1, col2, col3 = st.columns([1, 1, 1])
    with col2:
        if st.button("üõ†Ô∏è Buscar Profesionales", key="search_professionals"):
            from modules.marketplace import service_providers
            service_providers.show_services_marketplace()

    st.stop()  # Detener ejecuci√≥n para Home

elif st.session_state.get('selected_page') == "Propietario (Gemelo Digital)":
    with st.container():
        # Flujo principal: Propietario sube finca ‚Üí IA genera plan
        from modules.marketplace import gemelo_digital
        gemelo_digital.main()

elif st.session_state.get('selected_page') == "Propietarios (Subir Fincas)":
    with st.container():
        # Propietarios suben fincas al marketplace inmobiliario
        from modules.marketplace import owners
        owners.main()

elif st.session_state.get('selected_page') == "Dise√±ador de Vivienda":
    with st.container():
        # Flujo secundario: Cliente dise√±a vivienda personalizada
        from modules.marketplace import disenador_vivienda
        disenador_vivienda.main()

# "Inmobiliaria (Mapa)" route removed ‚Äî Home now uses `marketplace.main()` directly.

elif st.session_state.get('selected_page') == "üë§ Panel de Cliente":
    with st.container():
        # Panel de cliente con acceso a transacciones y servicios
        from modules.marketplace import client_panel_fixed as client_panel
        client_panel.main()

elif st.session_state.get('selected_page') == "Arquitectos (Marketplace)":
    with st.container():
        # Use the new main() entrypoint which handles auth, plans and upload flow
        from modules.marketplace import marketplace_upload
        marketplace_upload.main()

elif st.session_state.get('selected_page') == "Intranet":
    st.write("Cargando Panel de Control...")
    with st.container():
        from modules.marketplace import intranet
        intranet.main()

elif st.session_state.get('selected_page') == "üë§ Panel de Proveedor":
    with st.container():
        from modules.marketplace import service_providers
        service_providers.show_service_provider_panel()

elif st.session_state.get('selected_page') == "üìù Registro de Proveedor de Servicios":
    with st.container():
        from modules.marketplace import service_providers
        service_providers.show_service_provider_registration()

elif st.session_state.get('selected_page') == "Iniciar Sesi√≥n":
    with st.container():
        from modules.marketplace import auth
        auth.show_login()
        st.stop()

elif st.session_state.get('selected_page') == "Registro de Usuario":
    with st.container():
        from modules.marketplace import auth
        auth.show_registration()
        st.stop()
